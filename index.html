<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Agent 137 : Mission Confusion</title>
    <style>
        /* ============================================
           PARTIE 1: RESET & BASE
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #0a0a0f;
            color: white;
        }

        /* ============================================
           Ã‰CRANS DU JEU
           ============================================ */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .screen.active {
            display: flex;
        }

        /* Ã‰CRAN TITRE */
        #title-screen {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a0a2e 50%, #0f0f1a 100%);
        }

        .title-container {
            text-align: center;
            animation: fadeInUp 1s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-title {
            font-size: 4rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
            text-shadow: 0 0 30px rgba(255,107,107,0.5);
            margin-bottom: 10px;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .game-subtitle {
            font-size: 1.5rem;
            color: #888;
            margin-bottom: 50px;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .btn {
            padding: 15px 50px;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            box-shadow: 0 5px 20px rgba(255,107,107,0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 30px rgba(255,107,107,0.6);
        }

        .btn-secondary {
            background: transparent;
            color: #888;
            border: 2px solid #444;
        }

        .btn-secondary:hover {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        /* TITRE ANIMÃ‰ AGENT 137 */
        .agent-preview {
            font-size: 8rem;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        /* ============================================
           Ã‰CRAN DE JEU
           ============================================ */
        #game-screen {
            background: transparent;
            z-index: 1;
        }

        /* HUD - Interface en haut */
        .hud {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 50;
        }

        .hud-left, .hud-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .level-info {
            font-size: 1.2rem;
            color: #feca57;
            font-weight: bold;
        }

        .level-name {
            font-size: 0.9rem;
            color: #888;
        }

        .timer {
            font-size: 2rem;
            font-weight: bold;
            color: #48dbfb;
            font-family: 'Courier New', monospace;
        }

        .timer.warning {
            color: #ff6b6b;
            animation: pulse 0.5s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* BARRE DE CONFUSION */
        .confusion-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            max-width: 600px;
            z-index: 50;
        }

        .confusion-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .confusion-bar {
            height: 25px;
            background: #1a1a2e;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid #333;
            position: relative;
        }

        .confusion-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #48dbfb, #ff6b6b, #feca57);
            background-size: 200% 100%;
            border-radius: 15px;
            transition: width 0.5s ease;
            position: relative;
        }

        .confusion-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .confusion-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: white;
            text-shadow: 0 0 5px black;
        }

        /* Zone de jeu */
        .game-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* ============================================
           PARTIE 2: BACKGROUND PARALLAX
           ============================================ */
        .parallax-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .parallax-layer {
            position: absolute;
            width: 200%;
            height: 100%;
            background-repeat: repeat-x;
            background-size: contain;
        }

        /* Layer 1: Ciel Ã©toilÃ© + Lune */
        .sky-layer {
            background: linear-gradient(180deg, 
                #0a0a1a 0%, 
                #1a1a3a 30%, 
                #2a1a4a 60%,
                #1a0a2a 100%);
            width: 100%;
        }

        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .moon {
            position: absolute;
            top: 8%;
            right: 15%;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-radius: 50%;
            box-shadow: 0 0 50px rgba(253, 203, 110, 0.5),
                        0 0 100px rgba(253, 203, 110, 0.3);
            animation: moonGlow 4s ease-in-out infinite;
        }

        @keyframes moonGlow {
            0%, 100% { box-shadow: 0 0 50px rgba(253, 203, 110, 0.5), 0 0 100px rgba(253, 203, 110, 0.3); }
            50% { box-shadow: 0 0 70px rgba(253, 203, 110, 0.7), 0 0 140px rgba(253, 203, 110, 0.4); }
        }

        /* Layer 2: Buildings lointains */
        .buildings-far {
            bottom: 0;
            height: 50%;
            animation: parallaxSlow 60s linear infinite;
        }

        .building-far {
            position: absolute;
            bottom: 0;
            background: #0f0f1f;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }

        @keyframes parallaxSlow {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* Layer 3: Buildings proches + NÃ©ons */
        .buildings-near {
            bottom: 0;
            height: 60%;
            animation: parallaxMedium 40s linear infinite;
        }

        .building-near {
            position: absolute;
            bottom: 0;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
        }

        @keyframes parallaxMedium {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* NÃ©ons sur buildings */
        .neon {
            position: absolute;
            height: 4px;
            border-radius: 2px;
            animation: neonFlicker 3s ease-in-out infinite;
        }

        .neon.pink { background: #ff6b9d; box-shadow: 0 0 10px #ff6b9d, 0 0 20px #ff6b9d; }
        .neon.cyan { background: #48dbfb; box-shadow: 0 0 10px #48dbfb, 0 0 20px #48dbfb; }
        .neon.purple { background: #a55eea; box-shadow: 0 0 10px #a55eea, 0 0 20px #a55eea; }
        .neon.yellow { background: #feca57; box-shadow: 0 0 10px #feca57, 0 0 20px #feca57; }

        @keyframes neonFlicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
            52% { opacity: 1; }
            54% { opacity: 0.5; }
            56% { opacity: 1; }
        }

        /* Windows qui s'allument */
        .window {
            position: absolute;
            width: 8px;
            height: 12px;
            background: rgba(255, 200, 100, 0.3);
            animation: windowLight 5s ease-in-out infinite;
        }

        .window.lit {
            background: rgba(255, 220, 150, 0.9);
            box-shadow: 0 0 5px rgba(255, 200, 100, 0.5);
        }

        @keyframes windowLight {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Layer 4: Sol + Objets */
        .ground-layer {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 25%;
            background: linear-gradient(180deg, 
                transparent 0%,
                #0a0a15 20%,
                #0f0f1a 100%);
        }

        .street {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(180deg, #1a1a25 0%, #0f0f15 100%);
        }

        .street-line {
            position: absolute;
            bottom: 35px;
            width: 100%;
            height: 3px;
            background: repeating-linear-gradient(
                90deg,
                #feca57 0px,
                #feca57 40px,
                transparent 40px,
                transparent 80px
            );
            animation: streetMove 2s linear infinite;
        }

        @keyframes streetMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(-80px); }
        }

        /* Lampadaires */
        .lamppost {
            position: absolute;
            bottom: 80px;
        }

        .lamppost-pole {
            width: 6px;
            height: 120px;
            background: linear-gradient(180deg, #333 0%, #1a1a1a 100%);
            margin: 0 auto;
        }

        .lamppost-light {
            width: 30px;
            height: 15px;
            background: #feca57;
            border-radius: 0 0 15px 15px;
            margin: 0 auto;
            box-shadow: 0 10px 40px rgba(254, 202, 87, 0.6),
                        0 5px 20px rgba(254, 202, 87, 0.8);
            animation: lampFlicker 4s ease-in-out infinite;
        }

        @keyframes lampFlicker {
            0%, 100% { opacity: 1; }
            95% { opacity: 1; }
            96% { opacity: 0.5; }
            97% { opacity: 1; }
        }

        .light-cone {
            width: 60px;
            height: 100px;
            background: linear-gradient(180deg, 
                rgba(254, 202, 87, 0.3) 0%,
                transparent 100%);
            clip-path: polygon(30% 0%, 70% 0%, 100% 100%, 0% 100%);
            margin: 0 auto;
            margin-top: -5px;
        }

        /* Voitures qui passent */
        .car {
            position: absolute;
            bottom: 85px;
            width: 80px;
            height: 30px;
            animation: carPass 8s linear infinite;
        }

        .car-body {
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #2a2a3a 0%, #1a1a2a 100%);
            border-radius: 5px 15px 5px 5px;
            position: relative;
        }

        .car-window {
            position: absolute;
            top: 5px;
            right: 10px;
            width: 25px;
            height: 15px;
            background: rgba(100, 200, 255, 0.3);
            border-radius: 3px;
        }

        .car-lights {
            position: absolute;
            width: 10px;
            height: 6px;
            background: #ff6b6b;
            border-radius: 2px;
            top: 12px;
        }

        .car-lights.front { right: -5px; background: #ffeaa7; }
        .car-lights.back { left: -5px; }

        @keyframes carPass {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(calc(100vw + 100px)); }
        }

        .car.reverse {
            animation: carPassReverse 10s linear infinite;
        }

        @keyframes carPassReverse {
            0% { transform: translateX(calc(100vw + 100px)) scaleX(-1); }
            100% { transform: translateX(-100px) scaleX(-1); }
        }

        /* Panneaux lumineux */
        .sign {
            position: absolute;
            padding: 5px 15px;
            font-size: 0.8rem;
            font-weight: bold;
            border-radius: 3px;
            animation: signGlow 2s ease-in-out infinite alternate;
        }

        .sign.pink {
            background: rgba(255, 107, 157, 0.2);
            color: #ff6b9d;
            border: 2px solid #ff6b9d;
            box-shadow: 0 0 20px rgba(255, 107, 157, 0.5);
        }

        .sign.cyan {
            background: rgba(72, 219, 251, 0.2);
            color: #48dbfb;
            border: 2px solid #48dbfb;
            box-shadow: 0 0 20px rgba(72, 219, 251, 0.5);
        }

        @keyframes signGlow {
            0% { filter: brightness(1); }
            100% { filter: brightness(1.3); }
        }

        /* ============================================
           Ã‰CRAN DES MISSIONS
           ============================================ */
        .missions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            max-width: 900px;
            width: 90%;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
        }

        .mission-card {
            background: linear-gradient(135deg, rgba(30,30,50,0.9), rgba(20,20,40,0.9));
            border: 2px solid #333;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .mission-card:hover {
            transform: translateY(-5px);
            border-color: #48dbfb;
            box-shadow: 0 10px 30px rgba(72, 219, 251, 0.3);
        }

        .mission-card.completed {
            border-color: #2ecc71;
            background: linear-gradient(135deg, rgba(46,204,113,0.2), rgba(20,20,40,0.9));
        }

        .mission-card.completed::after {
            content: 'âœ…';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }

        .mission-card.locked {
            opacity: 0.5;
            filter: grayscale(0.5);
        }

        .mission-card.locked::after {
            content: 'ðŸ”’';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }

        .mission-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .mission-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .mission-description {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 15px;
        }

        .mission-progress {
            background: #222;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .mission-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #48dbfb, #ff6b6b);
            transition: width 0.5s ease;
        }

        .mission-reward {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            color: #feca57;
        }

        .secret-mission-teaser {
            margin-top: 30px;
            padding: 20px 40px;
            background: linear-gradient(135deg, rgba(100,0,100,0.3), rgba(50,0,50,0.3));
            border: 2px dashed #9b59b6;
            border-radius: 15px;
            color: #9b59b6;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: secretPulse 2s ease-in-out infinite;
        }

        .secret-mission-teaser:hover {
            background: linear-gradient(135deg, rgba(155,89,182,0.3), rgba(100,50,150,0.3));
            border-color: #e056fd;
            color: #e056fd;
            transform: scale(1.05);
        }

        .secret-mission-teaser.unlocked {
            background: linear-gradient(135deg, rgba(231,76,60,0.3), rgba(192,57,43,0.3));
            border: 2px solid #e74c3c;
            color: #e74c3c;
            animation: secretUnlocked 0.5s ease;
        }

        @keyframes secretPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(155,89,182,0.3); }
            50% { box-shadow: 0 0 30px rgba(155,89,182,0.6); }
        }

        @keyframes secretUnlocked {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Particules flottantes */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(72, 219, 251, 0.6);
            border-radius: 50%;
            animation: particleFloat 10s linear infinite;
        }

        @keyframes particleFloat {
            0% { transform: translateY(100vh) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) translateX(50px); opacity: 0; }
        }

        /* ============================================
           PARTIE 3: AGENT 137 CHARACTER
           ============================================ */
        .agent-container {
            position: fixed;
            bottom: 280px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 40;
            transition: left 1s ease-out;
        }

        .agent {
            width: 120px;
            height: 200px;
            position: relative;
            transform-origin: bottom center;
        }

        /* TÃªte */
        .agent-head {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 70px;
            background: linear-gradient(180deg, #ffd5b5 0%, #f4c8a5 100%);
            border-radius: 30px 30px 25px 25px;
            z-index: 10;
        }

        /* Cheveux */
        .agent-hair {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 65px;
            height: 35px;
            background: #2c2c2c;
            border-radius: 35px 35px 0 0;
            z-index: 11;
        }

        .agent-hair::before {
            content: '';
            position: absolute;
            top: 20px;
            left: -3px;
            width: 15px;
            height: 25px;
            background: #2c2c2c;
            border-radius: 0 0 0 10px;
        }

        .agent-hair::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -3px;
            width: 15px;
            height: 25px;
            background: #2c2c2c;
            border-radius: 0 0 10px 0;
        }

        /* Lunettes */
        .agent-glasses {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 55px;
            height: 20px;
            z-index: 12;
        }

        .glass {
            position: absolute;
            width: 22px;
            height: 18px;
            background: rgba(50, 50, 80, 0.8);
            border: 2px solid #1a1a2e;
            border-radius: 4px;
        }

        .glass.left { left: 2px; }
        .glass.right { right: 2px; }

        .glass-bridge {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 3px;
            background: #1a1a2e;
        }

        /* Yeux (derriÃ¨re lunettes) */
        .agent-eyes {
            position: absolute;
            top: 28px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            display: flex;
            justify-content: space-between;
            z-index: 11;
        }

        .eye {
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }

        .pupil {
            width: 7px;
            height: 7px;
            background: #1a1a2e;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s ease;
        }

        /* Sourcils */
        .eyebrow {
            position: absolute;
            width: 15px;
            height: 4px;
            background: #2c2c2c;
            border-radius: 2px;
            top: 20px;
            transition: all 0.3s ease;
        }

        .eyebrow.left { left: 8px; transform: rotate(-5deg); }
        .eyebrow.right { right: 8px; transform: rotate(5deg); }

        /* Bouche */
        .agent-mouth {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 8px;
            border-bottom: 3px solid #c9927a;
            border-radius: 0 0 10px 10px;
            transition: all 0.3s ease;
        }

        /* Corps */
        .agent-body {
            position: absolute;
            top: 65px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 90px;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            border-radius: 10px 10px 0 0;
            z-index: 5;
        }

        /* Manteau */
        .agent-coat {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 95px;
            background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
            border-radius: 5px 5px 0 0;
            z-index: 4;
        }

        .coat-lapel {
            position: absolute;
            top: 5px;
            width: 15px;
            height: 40px;
            background: #3a3a5a;
        }

        .coat-lapel.left {
            left: 10px;
            transform: skewY(-10deg);
            border-radius: 0 5px 0 0;
        }

        .coat-lapel.right {
            right: 10px;
            transform: skewY(10deg);
            border-radius: 5px 0 0 0;
        }

        /* Cravate */
        .agent-tie {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 50px;
            background: linear-gradient(180deg, #ff6b6b 0%, #c0392b 100%);
            clip-path: polygon(50% 0%, 100% 10%, 80% 100%, 50% 90%, 20% 100%, 0% 10%);
            z-index: 6;
        }

        /* Badge 137 */
        .agent-badge {
            position: absolute;
            top: 75px;
            left: 15px;
            width: 25px;
            height: 25px;
            background: linear-gradient(135deg, #feca57 0%, #ff9f43 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: #1a1a2e;
            z-index: 7;
            box-shadow: 0 0 10px rgba(254, 202, 87, 0.5);
        }

        /* Bras */
        .agent-arm {
            position: absolute;
            top: 70px;
            width: 20px;
            height: 70px;
            background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
            border-radius: 10px;
            z-index: 3;
            transform-origin: top center;
            transition: transform 0.3s ease;
        }

        .agent-arm.left { left: 5px; }
        .agent-arm.right { right: 5px; }

        .agent-hand {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 18px;
            background: #ffd5b5;
            border-radius: 50%;
        }

        /* Jambes */
        .agent-legs {
            position: absolute;
            top: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: space-between;
            z-index: 2;
        }

        .agent-leg {
            width: 20px;
            height: 50px;
            background: #1a1a2e;
            border-radius: 0 0 5px 5px;
            transform-origin: top center;
            transition: transform 0.2s ease;
        }

        .agent-foot {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 25px;
            height: 10px;
            background: #0f0f1a;
            border-radius: 5px;
        }

        /* ============================================
           ANIMATIONS AGENT 137
           ============================================ */
        
        /* Idle - lÃ©ger balancement */
        .agent.idle {
            animation: agentIdle 3s ease-in-out infinite;
        }

        @keyframes agentIdle {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(1deg); }
        }

        /* Marche */
        .agent.walking .agent-leg.left {
            animation: walkLeft 0.4s ease-in-out infinite;
        }

        .agent.walking .agent-leg.right {
            animation: walkRight 0.4s ease-in-out infinite;
        }

        .agent.walking .agent-arm.left {
            animation: armSwingLeft 0.4s ease-in-out infinite;
        }

        .agent.walking .agent-arm.right {
            animation: armSwingRight 0.4s ease-in-out infinite;
        }

        @keyframes walkLeft {
            0%, 100% { transform: rotate(-15deg); }
            50% { transform: rotate(15deg); }
        }

        @keyframes walkRight {
            0%, 100% { transform: rotate(15deg); }
            50% { transform: rotate(-15deg); }
        }

        @keyframes armSwingLeft {
            0%, 100% { transform: rotate(10deg); }
            50% { transform: rotate(-10deg); }
        }

        @keyframes armSwingRight {
            0%, 100% { transform: rotate(-10deg); }
            50% { transform: rotate(10deg); }
        }

        /* Saut */
        .agent.jumping {
            animation: agentJump 0.6s ease-out;
        }

        @keyframes agentJump {
            0% { transform: translateY(0); }
            40% { transform: translateY(-80px); }
            100% { transform: translateY(0); }
        }

        /* Danse */
        .agent.dancing {
            animation: agentDance 0.5s ease-in-out infinite;
        }

        @keyframes agentDance {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            25% { transform: translateY(-10px) rotate(5deg); }
            50% { transform: translateY(0) rotate(-5deg); }
            75% { transform: translateY(-10px) rotate(5deg); }
        }

        .agent.dancing .agent-arm.left {
            animation: danceArmLeft 0.25s ease-in-out infinite;
        }

        .agent.dancing .agent-arm.right {
            animation: danceArmRight 0.25s ease-in-out infinite;
        }

        @keyframes danceArmLeft {
            0%, 100% { transform: rotate(-60deg); }
            50% { transform: rotate(-120deg); }
        }

        @keyframes danceArmRight {
            0%, 100% { transform: rotate(60deg); }
            50% { transform: rotate(120deg); }
        }

        /* Danse du poulet */
        .agent.chicken-dance {
            animation: chickenBody 0.3s ease-in-out infinite;
        }

        @keyframes chickenBody {
            0%, 100% { transform: translateY(0) scaleY(1); }
            50% { transform: translateY(-5px) scaleY(0.95); }
        }

        .agent.chicken-dance .agent-arm {
            animation: chickenWings 0.15s ease-in-out infinite;
        }

        @keyframes chickenWings {
            0%, 100% { transform: rotate(45deg) translateY(-10px); }
            50% { transform: rotate(80deg) translateY(-20px); }
        }

        .agent.chicken-dance .agent-head {
            animation: chickenHead 0.2s ease-in-out infinite;
        }

        @keyframes chickenHead {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(5px); }
        }

        /* Robot cassÃ© */
        .agent.robot-broken {
            animation: robotBody 0.1s linear infinite;
        }

        @keyframes robotBody {
            0% { transform: translateX(-3px) rotate(-2deg); }
            25% { transform: translateX(3px) rotate(2deg); }
            50% { transform: translateX(-2px) rotate(1deg); }
            75% { transform: translateX(2px) rotate(-1deg); }
            100% { transform: translateX(-3px) rotate(-2deg); }
        }

        .agent.robot-broken .agent-arm {
            animation: robotArms 0.2s steps(2) infinite;
        }

        @keyframes robotArms {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
            100% { transform: rotate(0deg); }
        }

        /* Chute dramatique */
        .agent.dramatic-fall {
            animation: dramaticFall 2s ease-in forwards;
        }

        @keyframes dramaticFall {
            0% { transform: rotate(0deg) translateY(0); }
            30% { transform: rotate(-10deg) translateY(-20px); }
            50% { transform: rotate(5deg) translateY(0); }
            70% { transform: rotate(-5deg) translateY(-10px); }
            100% { transform: rotate(90deg) translateY(50px) translateX(30px); }
        }

        /* Chante faux */
        .agent.singing {
            animation: singBody 0.8s ease-in-out infinite;
        }

        @keyframes singBody {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .agent.singing .agent-mouth {
            animation: singMouth 0.4s ease-in-out infinite;
        }

        @keyframes singMouth {
            0%, 100% { height: 8px; width: 20px; border-radius: 0 0 10px 10px; }
            50% { height: 15px; width: 25px; border-radius: 50%; }
        }

        /* Imite un chat */
        .agent.cat-mode .agent-hand {
            border-radius: 50% 50% 30% 30%;
        }

        .agent.cat-mode .agent-arm {
            animation: catPaws 0.5s ease-in-out infinite;
        }

        @keyframes catPaws {
            0%, 100% { transform: rotate(-30deg) translateY(-20px); }
            50% { transform: rotate(30deg) translateY(-30px); }
        }

        /* Spin */
        .agent.spinning {
            animation: agentSpin 0.8s ease-in-out;
        }

        @keyframes agentSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Confus */
        .agent.confused {
            animation: confusedShake 0.3s ease-in-out infinite;
        }

        @keyframes confusedShake {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }

        .agent.confused .agent-head {
            animation: confusedHead 0.5s ease-in-out infinite;
        }

        @keyframes confusedHead {
            0%, 100% { transform: translateX(-50%) rotate(-5deg); }
            50% { transform: translateX(-50%) rotate(5deg); }
        }

        /* Salut (wave) */
        .agent.waving .agent-arm.right {
            animation: waveArm 0.5s ease-in-out infinite;
            transform-origin: top center;
        }

        @keyframes waveArm {
            0%, 100% { transform: rotate(-120deg); }
            50% { transform: rotate(-150deg); }
        }

        /* PensÃ©e */
        .agent.thinking .agent-arm.right {
            transform: rotate(-45deg) translateY(-20px);
        }

        .agent.thinking .agent-head {
            animation: thinkHead 2s ease-in-out infinite;
        }

        @keyframes thinkHead {
            0%, 100% { transform: translateX(-50%) rotate(0deg); }
            50% { transform: translateX(-50%) rotate(10deg) translateY(-3px); }
        }

        /* Bulle de pensÃ©e */
        .thought-bubble {
            position: absolute;
            top: -60px;
            right: -80px;
            background: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 1.5rem;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
        }

        .thought-bubble::before {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20px;
            width: 15px;
            height: 15px;
            background: white;
            border-radius: 50%;
        }

        .thought-bubble::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 10px;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
        }

        .agent.thinking .thought-bubble {
            opacity: 1;
            transform: scale(1);
        }

        /* Expression selon confusion */
        .agent.mood-confident .eyebrow {
            transform: translateY(-3px);
        }

        .agent.mood-worried .eyebrow.left {
            transform: rotate(15deg) translateY(2px);
        }

        .agent.mood-worried .eyebrow.right {
            transform: rotate(-15deg) translateY(2px);
        }

        .agent.mood-confused .eyebrow {
            animation: eyebrowConfused 0.5s ease-in-out infinite alternate;
        }

        @keyframes eyebrowConfused {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-5px) rotate(20deg); }
        }

        .agent.mood-panicked .agent-head {
            animation: panicHead 0.2s ease-in-out infinite;
        }

        @keyframes panicHead {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        /* ============================================
           SKINS DES PERSONNAGES
           ============================================ */
        
        /* AGENT 137 - Default spy (dark suit, red tie) */
        .agent.agent137 .agent-body { background: linear-gradient(135deg, #1a1a2e, #16213e); }
        .agent.agent137 .agent-tie { background: linear-gradient(to bottom, #e53935, #c62828); }
        .agent.agent137 .agent-badge::after { content: '137'; }
        .agent.agent137 .agent-hair { background: linear-gradient(to bottom, #2c2c2c, #1a1a1a); }
        .agent.agent137 .agent-glasses { border-color: #333; background: rgba(0,0,0,0.7); }

        /* AGENT 42 - Robot spy (metallic, blue accents) */
        .agent.agent42 .agent-body { 
            background: linear-gradient(135deg, #37474f, #546e7a); 
            box-shadow: inset 0 0 10px rgba(0,200,255,0.3);
        }
        .agent.agent42 .agent-head { 
            background: linear-gradient(to bottom, #90a4ae, #78909c);
            border: 2px solid #607d8b;
        }
        .agent.agent42 .agent-hair { 
            background: linear-gradient(to bottom, #455a64, #37474f);
            border-radius: 50%;
        }
        .agent.agent42 .agent-eyes { 
            background: #00e5ff;
            box-shadow: 0 0 10px #00e5ff;
        }
        .agent.agent42 .pupil { 
            background: #00bcd4;
            box-shadow: 0 0 5px #00bcd4;
        }
        .agent.agent42 .agent-tie { 
            background: linear-gradient(to bottom, #00bcd4, #0097a7);
            box-shadow: 0 0 8px rgba(0,188,212,0.5);
        }
        .agent.agent42 .agent-badge::after { content: '42'; }
        .agent.agent42 .agent-glasses { 
            border-color: #00bcd4;
            background: rgba(0,188,212,0.2);
            box-shadow: 0 0 10px rgba(0,188,212,0.5);
        }
        .agent.agent42 .agent-hand { background: #78909c; }
        /* Robot antenna */
        .agent.agent42::before {
            content: '';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 20px;
            background: #546e7a;
            border-radius: 2px;
        }
        .agent.agent42::after {
            content: '';
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: #00e5ff;
            border-radius: 50%;
            animation: robotBlink 1s ease-in-out infinite;
        }
        @keyframes robotBlink {
            0%, 100% { opacity: 1; box-shadow: 0 0 15px #00e5ff; }
            50% { opacity: 0.5; box-shadow: 0 0 5px #00e5ff; }
        }

        /* SOCRATE - Greek philosopher (toga, beard, laurel) */
        .agent.socrates .agent-body { 
            background: linear-gradient(135deg, #f5f5dc, #e8e8d0);
            border-radius: 0 0 30px 30px;
        }
        .agent.socrates .agent-coat { display: none; }
        .agent.socrates .agent-tie { display: none; }
        .agent.socrates .agent-badge { display: none; }
        .agent.socrates .agent-head { background: linear-gradient(to bottom, #e8d5b7, #d4c4a8); }
        .agent.socrates .agent-hair { 
            background: linear-gradient(to bottom, #e0e0e0, #bdbdbd);
            width: 85px;
            height: 25px;
            top: -8px;
            border-radius: 50% 50% 0 0;
        }
        .agent.socrates .agent-glasses { display: none; }
        .agent.socrates .agent-eyes { background: #5d4037; }
        .agent.socrates .pupil { background: #3e2723; }
        /* Beard for Socrate */
        .agent.socrates .agent-mouth::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 35px;
            background: linear-gradient(to bottom, #e0e0e0, #bdbdbd);
            border-radius: 0 0 50% 50%;
            clip-path: polygon(10% 0%, 90% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%);
        }
        /* Laurel wreath */
        .agent.socrates .agent-head::before {
            content: 'ðŸŒ¿';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
        }
        /* Toga draping */
        .agent.socrates .agent-arm { background: linear-gradient(135deg, #f5f5dc, #e8e8d0); }
        .agent.socrates .agent-hand { background: #d4c4a8; }
        .agent.socrates .agent-foot { background: #8d6e63; }

        /* NIETZSCHE - Dark philosopher (mustache, intense) */
        .agent.nietzsche .agent-body { 
            background: linear-gradient(135deg, #1b1b1b, #2d2d2d);
        }
        .agent.nietzsche .agent-coat { 
            background: linear-gradient(to bottom, #212121, #0d0d0d);
        }
        .agent.nietzsche .agent-tie { 
            background: linear-gradient(to bottom, #4a148c, #311b92);
        }
        .agent.nietzsche .agent-badge { display: none; }
        .agent.nietzsche .agent-head { background: linear-gradient(to bottom, #e8d5b7, #d4c4a8); }
        .agent.nietzsche .agent-hair { 
            background: linear-gradient(to bottom, #4a4a4a, #2d2d2d);
            width: 75px;
            top: -12px;
        }
        .agent.nietzsche .agent-glasses { display: none; }
        .agent.nietzsche .agent-eyes { 
            background: #1a1a1a;
            box-shadow: inset 0 0 5px #000;
        }
        .agent.nietzsche .pupil { background: #424242; }
        .agent.nietzsche .eyebrow { 
            background: #4a4a4a;
            height: 5px;
            transform: rotate(-10deg);
        }
        /* Magnificent mustache */
        .agent.nietzsche .agent-mouth::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 15px;
            background: #4a4a4a;
            border-radius: 0 0 50% 50%;
            clip-path: polygon(0% 0%, 100% 0%, 90% 100%, 50% 70%, 10% 100%);
        }

        /* DESCARTES - Rational philosopher (wig, formal) */
        .agent.descartes .agent-body { 
            background: linear-gradient(135deg, #1a237e, #283593);
        }
        .agent.descartes .agent-coat { 
            background: linear-gradient(to bottom, #1a237e, #0d1b6e);
        }
        .agent.descartes .coat-lapel { background: #c0a062; }
        .agent.descartes .agent-tie { 
            background: #fff;
            width: 30px;
            height: 25px;
            border-radius: 5px;
            clip-path: none;
        }
        .agent.descartes .agent-badge { display: none; }
        .agent.descartes .agent-head { background: linear-gradient(to bottom, #f5e6d3, #e8d5c4); }
        /* 17th century wig */
        .agent.descartes .agent-hair { 
            background: linear-gradient(to bottom, #1a1a1a, #2d2d2d);
            width: 90px;
            height: 35px;
            top: -15px;
            border-radius: 20px 20px 50% 50%;
        }
        .agent.descartes .agent-hair::before {
            content: '';
            position: absolute;
            top: 25px;
            left: -5px;
            width: 25px;
            height: 40px;
            background: linear-gradient(to bottom, #1a1a1a, #2d2d2d);
            border-radius: 0 0 50% 50%;
        }
        .agent.descartes .agent-hair::after {
            content: '';
            position: absolute;
            top: 25px;
            right: -5px;
            width: 25px;
            height: 40px;
            background: linear-gradient(to bottom, #1a1a1a, #2d2d2d);
            border-radius: 0 0 50% 50%;
        }
        .agent.descartes .agent-glasses { display: none; }
        .agent.descartes .agent-eyes { background: #4e342e; }
        .agent.descartes .pupil { background: #3e2723; }

        /* DIOGÃˆNE - Cynical philosopher (barrel, messy) */
        .agent.diogenes .agent-body { 
            background: linear-gradient(135deg, #5d4037, #4e342e);
            border-radius: 20px;
            width: 80px;
            height: 100px;
        }
        .agent.diogenes .agent-coat { display: none; }
        .agent.diogenes .agent-tie { display: none; }
        .agent.diogenes .agent-badge { display: none; }
        .agent.diogenes .agent-head { 
            background: linear-gradient(to bottom, #d7ccc8, #bcaaa4);
        }
        .agent.diogenes .agent-hair { 
            background: linear-gradient(to bottom, #8d6e63, #6d4c41);
            width: 85px;
            height: 30px;
            top: -12px;
            border-radius: 50%;
        }
        .agent.diogenes .agent-glasses { display: none; }
        .agent.diogenes .agent-eyes { background: #5d4037; }
        .agent.diogenes .pupil { background: #3e2723; }
        /* Messy beard */
        .agent.diogenes .agent-mouth::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 40px;
            background: linear-gradient(to bottom, #8d6e63, #6d4c41);
            border-radius: 0 0 40% 40%;
        }
        /* Barrel effect */
        .agent.diogenes::before {
            content: '';
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 80px;
            background: linear-gradient(90deg, #6d4c41 0%, #8d6e63 20%, #a1887f 50%, #8d6e63 80%, #6d4c41 100%);
            border-radius: 10px;
            border: 4px solid #4e342e;
            z-index: -1;
        }
        /* Barrel rings */
        .agent.diogenes::after {
            content: '';
            position: absolute;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            width: 110px;
            height: 8px;
            background: #5d4037;
            border-radius: 2px;
            box-shadow: 0 35px 0 #5d4037;
            z-index: -1;
        }
        .agent.diogenes .agent-arm { background: #bcaaa4; }
        .agent.diogenes .agent-hand { background: #d7ccc8; }
        .agent.diogenes .agent-legs { display: none; }

        /* ============================================
           ANIMATIONS SPÃ‰CIFIQUES PAR PERSONNAGE
           ============================================ */
        
        /* Agent 137 - Ajustement lunettes */
        @keyframes adjustGlasses {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .agent.agent137.adjusting-glasses .agent-glasses {
            animation: adjustGlasses 0.5s ease-in-out;
        }
        .agent.agent137.adjusting-glasses .agent-arm.right {
            transform: rotate(-60deg) translateY(-30px);
        }

        /* Agent 42 - Scan mode */
        @keyframes robotScan {
            0% { box-shadow: 0 0 10px #00e5ff; }
            50% { box-shadow: 0 0 30px #00e5ff, 0 0 60px #00e5ff; }
            100% { box-shadow: 0 0 10px #00e5ff; }
        }
        .agent.agent42.scanning .agent-eyes {
            animation: robotScan 0.5s ease-in-out infinite;
        }
        .agent.agent42.scanning::after {
            animation: robotBlink 0.2s ease-in-out infinite;
        }

        /* Agent 42 - Error/Glitch */
        @keyframes robotGlitch {
            0%, 100% { transform: translateX(0); filter: hue-rotate(0deg); }
            25% { transform: translateX(-5px); filter: hue-rotate(90deg); }
            50% { transform: translateX(5px); filter: hue-rotate(180deg); }
            75% { transform: translateX(-3px); filter: hue-rotate(270deg); }
        }
        .agent.agent42.glitching {
            animation: robotGlitch 0.3s ease-in-out infinite;
        }

        /* Socrate - Stroking beard */
        @keyframes strokeBeard {
            0%, 100% { transform: rotate(-20deg) translateY(-10px); }
            50% { transform: rotate(-25deg) translateY(-15px); }
        }
        .agent.socrates.pondering .agent-arm.right {
            animation: strokeBeard 1s ease-in-out infinite;
        }

        /* Socrate - Questioning gesture */
        @keyframes questionGesture {
            0%, 100% { transform: rotate(-100deg); }
            50% { transform: rotate(-130deg) translateY(-10px); }
        }
        .agent.socrates.questioning .agent-arm.left {
            animation: questionGesture 1.5s ease-in-out infinite;
        }
        .agent.socrates.questioning .agent-arm.right {
            animation: questionGesture 1.5s ease-in-out infinite reverse;
        }

        /* Nietzsche - Dramatic pose */
        @keyframes dramaticPose {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.05) rotate(-2deg); }
        }
        .agent.nietzsche.dramatic {
            animation: dramaticPose 2s ease-in-out infinite;
        }
        .agent.nietzsche.dramatic .agent-arm.right {
            transform: rotate(-150deg);
        }

        /* Nietzsche - Intense stare */
        @keyframes intenseStare {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .agent.nietzsche.intense .agent-eyes {
            animation: intenseStare 1s ease-in-out infinite;
        }
        .agent.nietzsche.intense .eyebrow {
            transform: rotate(-15deg) translateY(-5px);
        }

        /* Descartes - Thinking deeply */
        @keyframes deepThought {
            0%, 100% { transform: translateX(-50%) rotate(0deg); }
            25% { transform: translateX(-50%) rotate(5deg); }
            75% { transform: translateX(-50%) rotate(-5deg); }
        }
        .agent.descartes.cogito .agent-head {
            animation: deepThought 3s ease-in-out infinite;
        }
        .agent.descartes.cogito .agent-arm.right {
            transform: rotate(-40deg) translateY(-20px);
        }

        /* Descartes - Eureka moment */
        @keyframes eurekaJump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .agent.descartes.eureka {
            animation: eurekaJump 0.5s ease-in-out;
        }
        .agent.descartes.eureka .agent-arm {
            transform: rotate(-160deg);
        }

        /* DiogÃ¨ne - Cynical laugh */
        @keyframes cynicalLaugh {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.03) rotate(2deg); }
            75% { transform: scale(1.03) rotate(-2deg); }
        }
        .agent.diogenes.laughing {
            animation: cynicalLaugh 0.5s ease-in-out infinite;
        }

        /* DiogÃ¨ne - Looking for honest man (with lantern) */
        @keyframes searchHonest {
            0%, 100% { transform: rotate(-80deg); }
            50% { transform: rotate(-120deg); }
        }
        .agent.diogenes.searching .agent-arm.right {
            animation: searchHonest 2s ease-in-out infinite;
        }
        .agent.diogenes.searching::before {
            box-shadow: 0 0 20px #ffd54f, 0 0 40px #ffd54f;
        }

        /* ============================================
           RÃ‰ACTIONS Ã‰MOTIONNELLES PAR PERSONNAGE
           ============================================ */
        
        /* Happy reactions */
        .agent.agent137.happy { animation: dancing 0.5s ease-in-out infinite; }
        .agent.agent42.happy { animation: robotScan 0.3s ease-in-out infinite; }
        .agent.socrates.happy .agent-mouth { transform: scaleY(1.5); }
        .agent.nietzsche.happy { animation: dramaticPose 1s ease-in-out; }
        .agent.descartes.happy { animation: eurekaJump 0.5s ease-in-out; }
        .agent.diogenes.happy { animation: cynicalLaugh 0.3s ease-in-out infinite; }

        /* Angry reactions */
        .agent.agent137.angry .agent-glasses { filter: brightness(0.5); }
        .agent.agent42.angry { filter: hue-rotate(180deg); }
        .agent.socrates.angry .eyebrow { transform: rotate(-20deg); }
        .agent.nietzsche.angry { filter: saturate(2) brightness(0.8); }
        .agent.descartes.angry .agent-hair { animation: shake 0.1s infinite; }
        .agent.diogenes.angry { transform: scale(1.1); }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(3px); }
        }

        /* Confused reactions */
        .agent.agent137.confused .agent-head { animation: confusedHead 0.5s ease-in-out infinite; }
        .agent.agent42.confused { animation: robotGlitch 0.5s ease-in-out infinite; }
        .agent.socrates.confused .agent-arm { animation: questionGesture 1s ease-in-out infinite; }
        .agent.nietzsche.confused .agent-eyes { animation: intenseStare 0.5s ease-in-out infinite; }
        .agent.descartes.confused { animation: deepThought 1s ease-in-out infinite; }
        .agent.diogenes.confused { animation: searchHonest 1s ease-in-out infinite; }

        /* ============================================
           ZONE DE CHAT
           ============================================ */
        .chat-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 700px;
            background: rgba(15, 15, 30, 0.95);
            border-radius: 20px;
            border: 1px solid #333;
            overflow: hidden;
            z-index: 50;
            backdrop-filter: blur(10px);
        }

        .messages {
            height: 200px;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            animation: messageIn 0.3s ease-out;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.bot {
            background: #2a2a4a;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message em {
            color: #feca57;
            font-style: italic;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            gap: 10px;
            border-top: 1px solid #333;
        }

        .chat-input {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: #1a1a2e;
            color: white;
            font-size: 1rem;
            outline: none;
        }

        .chat-input::placeholder {
            color: #666;
        }

        .send-btn {
            padding: 12px 25px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        /* ============================================
           BARRE D'INDICES
           ============================================ */
        .hints-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .hint-toggle {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
            color: #1a1a2e;
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(254, 202, 87, 0.4);
        }

        .hint-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(254, 202, 87, 0.6);
        }

        .hints-content {
            display: none;
            gap: 8px;
            flex-wrap: wrap;
            flex: 1;
            animation: hintsSlide 0.3s ease-out;
        }

        .hints-content.show {
            display: flex;
        }

        @keyframes hintsSlide {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .hint-chip {
            background: rgba(84, 160, 255, 0.2);
            color: #54a0ff;
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(84, 160, 255, 0.3);
        }

        .hint-chip:hover {
            background: rgba(84, 160, 255, 0.4);
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(84, 160, 255, 0.5);
        }

        /* ============================================
           Ã‰CRAN VICTOIRE NIVEAU
           ============================================ */
        #victory-screen {
            background: rgba(0, 0, 0, 0.9);
        }

        .victory-content {
            text-align: center;
            animation: victoryPop 0.5s ease-out;
        }

        @keyframes victoryPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .victory-title {
            font-size: 3rem;
            color: #feca57;
            margin-bottom: 10px;
        }

        .victory-subtitle {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 40px;
        }

        .reward-choice {
            display: flex;
            gap: 30px;
            justify-content: center;
        }

        .reward-btn {
            padding: 30px 40px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border: 3px solid transparent;
        }

        .reward-btn:hover {
            transform: translateY(-10px);
        }

        .reward-btn.action {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
        }

        .reward-btn.action:hover {
            box-shadow: 0 10px 40px rgba(255,107,107,0.5);
        }

        .reward-btn.truth {
            background: linear-gradient(135deg, #48dbfb, #667eea);
        }

        .reward-btn.truth:hover {
            box-shadow: 0 10px 40px rgba(72,219,251,0.5);
        }

        .reward-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .reward-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .reward-desc {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* ============================================
           Ã‰CRAN ACTION
           ============================================ */
        #action-screen {
            background: rgba(0, 0, 0, 0.95);
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 800px;
            margin-top: 30px;
        }

        .action-card {
            background: #1a1a2e;
            border: 2px solid #333;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-card:hover {
            border-color: #ff6b6b;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255,107,107,0.3);
        }

        .action-emoji {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .action-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .action-desc {
            font-size: 0.8rem;
            color: #888;
        }

        /* ============================================
           Ã‰CRAN VÃ‰RITÃ‰
           ============================================ */
        #truth-screen {
            background: rgba(0, 0, 0, 0.95);
        }

        .truth-container {
            text-align: center;
            max-width: 600px;
        }

        .truth-input {
            width: 100%;
            padding: 15px 25px;
            border: 2px solid #48dbfb;
            border-radius: 15px;
            background: #1a1a2e;
            color: white;
            font-size: 1.1rem;
            margin: 30px 0;
            outline: none;
        }

        .suggested-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .question-chip {
            padding: 10px 20px;
            background: #2a2a4a;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .question-chip:hover {
            background: #48dbfb;
            color: #0a0a0f;
        }

        /* ============================================
           Ã‰CRAN GAME OVER
           ============================================ */
        #gameover-screen {
            background: rgba(20, 0, 0, 0.95);
        }

        .gameover-title {
            font-size: 4rem;
            color: #ff6b6b;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Effet de confusion flottant */
        @keyframes floatUp {
            0% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-50px); }
        }

        /* Effet milestone */
        @keyframes milestonePop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            30% { transform: translate(-50%, -50%) scale(1); }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        }

        /* Barre de confusion pulsante quand haute */
        .confusion-bar.critical .confusion-fill {
            animation: criticalPulse 0.5s ease-in-out infinite;
        }

        @keyframes criticalPulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
        }

        .gameover-reason {
            font-size: 1.2rem;
            color: #888;
            margin: 20px 0 40px;
        }

        .stats-container {
            background: #1a1a2e;
            padding: 20px 40px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        /* ============================================
           Ã‰CRAN VICTOIRE FINALE
           ============================================ */
        #final-victory-screen {
            background: radial-gradient(ellipse at center, #1a0a3e 0%, #0a0a1a 100%);
            overflow-y: auto;
        }

        .final-victory-container {
            text-align: center;
            padding: 30px;
            animation: victoryAppear 1s ease-out;
        }

        @keyframes victoryAppear {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .trophy-animation {
            font-size: 8rem;
            animation: trophySpin 2s ease-in-out infinite;
            filter: drop-shadow(0 0 30px #feca57);
        }

        @keyframes trophySpin {
            0%, 100% { transform: rotate(-10deg) scale(1); }
            50% { transform: rotate(10deg) scale(1.1); }
        }

        .final-title {
            font-size: 3rem;
            background: linear-gradient(135deg, #feca57 0%, #ff6b6b 50%, #ff9ff3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 20px 0 10px;
            animation: titleGlow 2s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }

        .final-subtitle {
            color: #888;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .achievement-showcase {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .achievement-badge {
            background: linear-gradient(145deg, rgba(254, 202, 87, 0.2), rgba(255, 159, 243, 0.1));
            border: 2px solid #feca57;
            border-radius: 15px;
            padding: 15px 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            animation: badgeFloat 3s ease-in-out infinite;
        }

        .achievement-badge:nth-child(2) { animation-delay: 0.3s; }
        .achievement-badge:nth-child(3) { animation-delay: 0.6s; }

        @keyframes badgeFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .badge-icon {
            font-size: 2.5rem;
        }

        .badge-text {
            color: #feca57;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .final-agent-message {
            background: rgba(255, 107, 107, 0.1);
            border: 2px dashed #ff6b6b;
            border-radius: 20px;
            padding: 25px;
            margin: 30px auto;
            max-width: 500px;
            animation: glitchBox 4s ease-in-out infinite;
        }

        @keyframes glitchBox {
            0%, 90%, 100% { transform: translateX(0); }
            92% { transform: translateX(-5px); }
            94% { transform: translateX(5px); }
            96% { transform: translateX(-3px); }
            98% { transform: translateX(3px); }
        }

        @keyframes confettiFall {
            0% { 
                transform: translateY(0) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(100vh) rotate(720deg); 
                opacity: 0; 
            }
        }

        @keyframes scorePopup {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-40px) scale(0.8); }
        }

        @keyframes hintPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes toastOut {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, 20px); }
        }

        #final-agent-quote {
            color: #ff6b6b;
            font-style: italic;
            font-size: 1.1rem;
            margin: 0 0 10px 0;
        }

        .agent-defeated {
            color: #666;
            font-size: 0.85rem;
        }

        .final-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .final-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .final-stat .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #54a0ff;
        }

        .final-stat .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .credits-section {
            margin-top: 30px;
            color: #888;
            font-size: 0.9rem;
        }

        .credits-section p {
            margin: 8px 0;
        }

        .credits-section strong {
            color: #feca57;
        }

        /* ============================================
           PARTAGE SOCIAL
           ============================================ */
        .share-section {
            margin-top: 25px;
        }

        .share-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .share-btn.twitter {
            background: linear-gradient(135deg, #1da1f2, #0d8bd9);
            color: white;
        }

        .share-btn.copy {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
        }

        .share-btn.screenshot {
            background: linear-gradient(135deg, #00b894, #55efc4);
            color: #1a1a2e;
        }

        .share-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        /* ============================================
           Ã‰CRAN SÃ‰LECTION NIVEAU
           ============================================ */
        #level-select-screen {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a0a2e 100%);
        }

        .levels-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin: 40px 0;
        }

        .level-card {
            width: 120px;
            height: 120px;
            background: #1a1a2e;
            border: 3px solid #333;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-card.unlocked {
            border-color: #48dbfb;
        }

        .level-card.unlocked:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(72,219,251,0.5);
        }

        .level-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .level-card.completed {
            border-color: #feca57;
            background: linear-gradient(135deg, #1a1a2e, #2a2a1e);
        }

        .level-number {
            font-size: 2rem;
            font-weight: bold;
        }

        .level-stars {
            margin-top: 5px;
        }

        /* ============================================
           Ã‰CRAN SÃ‰LECTION PERSONNAGE
           ============================================ */
        .characters-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
            max-width: 800px;
        }

        .character-card {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border: 3px solid #333;
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .character-card.selected {
            border-color: var(--char-color, #48dbfb);
            box-shadow: 0 0 30px var(--char-color, rgba(72,219,251,0.5));
        }

        .character-avatar {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .character-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--char-color, #48dbfb);
            margin-bottom: 5px;
        }

        .character-desc {
            font-size: 0.8rem;
            color: #888;
        }

        .character-difficulty {
            margin-top: 10px;
            font-size: 0.75rem;
        }

        .difficulty-stars {
            color: #feca57;
        }

        /* ============================================
           Ã‰CRAN MODE DE JEU
           ============================================ */
        .mode-cards {
            display: flex;
            gap: 30px;
        }

        .mode-card {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border: 3px solid #333;
            border-radius: 25px;
            padding: 40px;
            width: 250px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .mode-card:hover {
            transform: scale(1.05);
            border-color: #48dbfb;
            box-shadow: 0 0 30px rgba(72,219,251,0.3);
        }

        .mode-card.selected {
            border-color: #feca57;
            box-shadow: 0 0 30px rgba(254,202,87,0.5);
        }

        .mode-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .mode-card h3 {
            color: #feca57;
            margin-bottom: 10px;
        }

        .mode-card p {
            color: #888;
            font-size: 0.9rem;
        }

        /* ============================================
           LEADERBOARD
           ============================================ */
        .leaderboard-container {
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            width: 500px;
            max-height: 400px;
            overflow-y: auto;
        }

        .leaderboard-entry {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #333;
            transition: background 0.3s;
        }

        .leaderboard-entry:hover {
            background: rgba(255,255,255,0.05);
        }

        .leaderboard-rank {
            font-size: 1.5rem;
            width: 50px;
            font-weight: bold;
        }

        .leaderboard-rank.gold { color: #feca57; }
        .leaderboard-rank.silver { color: #b2bec3; }
        .leaderboard-rank.bronze { color: #cd6133; }

        .leaderboard-info {
            flex: 1;
            margin-left: 15px;
        }

        .leaderboard-char {
            font-size: 0.9rem;
            color: #888;
        }

        .leaderboard-score {
            font-size: 1.3rem;
            font-weight: bold;
            color: #48dbfb;
        }

        .total-score-display {
            margin-top: 30px;
            font-size: 1.1rem;
            color: #888;
        }

        .total-score-display span {
            color: #feca57;
            font-weight: bold;
            font-size: 1.3rem;
        }

        /* Ã‰QUIPE & CRÃ‰DITS */
        .team-credits {
            margin-top: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .team-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, rgba(72, 219, 251, 0.2), rgba(155, 89, 182, 0.2));
            padding: 12px 25px;
            border-radius: 30px;
            border: 2px solid #48dbfb;
            animation: teamGlow 2s ease-in-out infinite alternate;
        }

        @keyframes teamGlow {
            0% { box-shadow: 0 0 10px rgba(72, 219, 251, 0.3); }
            100% { box-shadow: 0 0 25px rgba(72, 219, 251, 0.6); }
        }

        .team-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px #48dbfb;
        }

        .team-divider {
            color: #48dbfb;
        }

        .team-school {
            font-size: 1.1rem;
            color: #feca57;
            font-weight: bold;
        }

        .event-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: #888;
        }

        .challenge-badge {
            background: linear-gradient(90deg, #9b59b6, #e74c3c);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8rem;
            color: white;
            font-weight: bold;
        }

        /* ============================================
           SCORE & COMBO HUD
           ============================================ */
        .score-display {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 5px;
        }

        .score-value {
            font-size: 1rem;
            color: #feca57;
        }

        .combo-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff6b6b;
            animation: comboPulse 0.5s ease-in-out;
        }

        @keyframes comboPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        .combo-display.mega {
            color: #ff9ff3;
            font-size: 1.4rem;
            text-shadow: 0 0 10px #ff9ff3;
        }

        /* ============================================
           POWER-UPS
           ============================================ */
        .powerups-bar {
            display: flex;
            gap: 8px;
            margin-right: 10px;
        }

        .powerup-btn {
            background: linear-gradient(145deg, #2d3436, #1a1a2e);
            border: 2px solid #444;
            border-radius: 10px;
            padding: 8px 12px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .powerup-btn:hover:not(.cooldown):not(.active) {
            border-color: #48dbfb;
            transform: scale(1.1);
        }

        .powerup-btn.active {
            border-color: #4ade80;
            background: linear-gradient(145deg, #166534, #14532d);
            animation: powerupActive 1s infinite;
        }

        @keyframes powerupActive {
            0%, 100% { box-shadow: 0 0 10px #4ade80; }
            50% { box-shadow: 0 0 20px #4ade80; }
        }

        .powerup-btn.cooldown {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .powerup-btn .cooldown-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 100%;
            background: rgba(0,0,0,0.7);
            border-radius: 8px;
            transition: height 0.1s linear;
        }

        #hint-count {
            font-size: 0.7rem;
            vertical-align: super;
        }

        /* ============================================
           MÃ‰TÃ‰O - PARTICULES
           ============================================ */
        .weather-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
        }

        .rain-drop {
            position: absolute;
            width: 2px;
            background: linear-gradient(transparent, #48dbfb);
            animation: rainFall linear infinite;
        }

        @keyframes rainFall {
            0% { transform: translateY(-100vh); }
            100% { transform: translateY(100vh); }
        }

        .snow-flake {
            position: absolute;
            color: white;
            font-size: 1rem;
            animation: snowFall linear infinite;
        }

        @keyframes snowFall {
            0% { transform: translateY(-50px) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(360deg); }
        }

        .lightning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
        }

        .lightning.flash {
            animation: lightningFlash 0.2s ease-out;
        }

        @keyframes lightningFlash {
            0% { opacity: 0.8; }
            50% { opacity: 0.2; }
            100% { opacity: 0; }
        }

        /* ============================================
           EFFETS PARTICULES CONFUSION
           ============================================ */
        .particle-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        .spark {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #feca57;
            border-radius: 50%;
            animation: sparkFly 1s ease-out forwards;
        }

        @keyframes sparkFly {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0) translateY(-50px); opacity: 0; }
        }

        .glitch-line {
            position: fixed;
            left: 0;
            width: 100%;
            height: 2px;
            background: #ff6b6b;
            opacity: 0;
            z-index: 100;
            animation: glitchScan 0.1s linear;
        }

        @keyframes glitchScan {
            0% { opacity: 0.8; top: 0; }
            100% { opacity: 0; top: 100%; }
        }

        /* ============================================
           Ã‰CRAN DE PAUSE
           ============================================ */
        #pause-screen {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 200;
        }

        .pause-content {
            text-align: center;
            animation: fadeInScale 0.3s ease;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .pause-title {
            font-size: 4rem;
            color: #feca57;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(254, 202, 87, 0.5);
        }

        .pause-subtitle {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 40px;
            font-style: italic;
        }

        .pause-menu {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 350px;
            margin: 0 auto;
        }

        .pause-btn {
            padding: 18px 40px;
            font-size: 1.3rem;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .pause-btn.resume {
            background: linear-gradient(135deg, #48dbfb, #00d2d3);
            color: #1a1a2e;
        }

        .pause-btn.resume:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(72, 219, 251, 0.5);
        }

        .pause-btn.settings {
            background: linear-gradient(135deg, #feca57, #ff9f43);
            color: #1a1a2e;
        }

        .pause-btn.settings:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(254, 202, 87, 0.5);
        }

        .pause-btn.quit {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
        }

        .pause-btn.quit:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
        }

        .pause-stats {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pause-stats h3 {
            color: #feca57;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .pause-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .pause-stat {
            text-align: center;
        }

        .pause-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #48dbfb;
        }

        .pause-stat-label {
            font-size: 0.8rem;
            color: #888;
        }

        /* Settings dans pause */
        .pause-settings {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pause-settings.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            color: #ddd;
            font-size: 1rem;
        }

        .setting-toggle {
            width: 50px;
            height: 26px;
            background: #333;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .setting-toggle.active {
            background: #48dbfb;
        }

        .setting-toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .setting-toggle.active::after {
            transform: translateX(24px);
        }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            .game-title { font-size: 2rem; }
            .game-subtitle { font-size: 1rem; }
            .action-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .levels-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .level-card { width: 90px; height: 90px; }
            .characters-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .character-card { padding: 15px; }
            .character-avatar { font-size: 2rem; }
            .mode-cards { flex-direction: column; gap: 15px; }
            .mode-card { width: 200px; padding: 25px; }
            .chat-container { width: 98%; height: 45vh; max-height: 320px; }
            .confusion-container { width: 95%; top: 70px; }
            .powerups-bar { gap: 3px; }
            .powerup-btn { padding: 5px 7px; font-size: 0.75rem; }
            .leaderboard-container { width: 95%; padding: 15px; }
            .hud { padding: 8px 10px; flex-wrap: wrap; gap: 5px; }
            .hud-left, .hud-right { gap: 5px; }
            .timer { font-size: 1.5rem; }
            .agent-container { transform: scale(0.6); bottom: auto; top: 25%; }
            .btn { padding: 12px 30px; font-size: 1rem; }
            .score-display { font-size: 0.85rem; }
            .hints-bar { padding: 8px 10px; }
            .hint-chip { padding: 4px 10px; font-size: 0.7rem; }
            .final-title { font-size: 2rem; }
            .trophy-animation { font-size: 5rem; }
            .achievement-showcase { gap: 10px; flex-wrap: wrap; }
            .achievement-badge { padding: 10px 15px; }
            .pause-title { font-size: 2.5rem; }
            .pause-btn { padding: 14px 30px; font-size: 1.1rem; }
            .pause-stats-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .game-area { height: 40vh; }
            .messages { max-height: 180px; }
        }

        @media (max-width: 480px) {
            .game-title { font-size: 1.5rem; }
            .game-subtitle { font-size: 0.85rem; }
            .levels-grid { grid-template-columns: repeat(2, 1fr); }
            .level-card { width: 70px; height: 70px; font-size: 1.5rem; }
            .characters-grid { grid-template-columns: 1fr; }
            .chat-container { height: 40vh; max-height: 280px; }
            .agent-container { transform: scale(0.5); top: 20%; }
            .powerup-btn { padding: 4px 5px; font-size: 0.65rem; }
            .hud { padding: 5px 8px; }
            .timer { font-size: 1.2rem; }
            .confusion-container { top: 60px; }
            .confusion-bar { height: 20px; }
            .pause-title { font-size: 2rem; }
            .pause-menu { max-width: 280px; }
            .pause-btn { padding: 12px 20px; font-size: 1rem; }
            .team-badges { flex-direction: column; gap: 8px; }
            .messages { max-height: 150px; font-size: 0.9rem; }
            .chat-input { font-size: 16px; padding: 12px; }
            .send-btn { width: 50px; font-size: 1.2rem; }
        }

        /* Very small phones */
        @media (max-width: 360px) {
            .game-title { font-size: 1.3rem; }
            .btn { padding: 10px 20px; font-size: 0.9rem; }
            .level-card { width: 60px; height: 60px; }
            .agent-container { transform: scale(0.4); }
            .chat-container { height: 35vh; }
        }

        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .agent-container { transform: scale(0.4); top: 10%; }
            .chat-container { height: 50vh; }
            .confusion-container { top: 50px; }
            .game-area { height: 30vh; }
            .screen { padding: 10px; }
        }

        /* Touch-friendly */
        @media (hover: none) and (pointer: coarse) {
            .btn, .powerup-btn, .hint-chip, .level-card, .character-card, .pause-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .send-btn {
                width: 55px;
                height: 48px;
            }
            
            .chat-input {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 14px;
            }
            
            /* Larger touch targets */
            .hint-chip {
                padding: 8px 14px;
            }
            
            .powerup-btn {
                padding: 8px 10px;
            }
        }

        /* Safe area for notched phones */
        @supports (padding: max(0px)) {
            .hud {
                padding-top: max(8px, env(safe-area-inset-top));
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
            }
            
            .chat-container {
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <!-- ============================================
         Ã‰CRAN TITRE
         ============================================ -->
    <div id="title-screen" class="screen active">
        <div class="title-container">
            <div class="agent-preview" id="title-agent-preview">ðŸ•µï¸</div>
            <h1 class="game-title">AGENT 137</h1>
            <p class="game-subtitle">Mission : Confusion Totale</p>
            <div class="menu-buttons">
                <button class="btn btn-primary" onclick="showScreen('character-select-screen')">
                    ðŸŽ® JOUER
                </button>
                <button class="btn btn-secondary" onclick="showScreen('missions-screen')">
                    ðŸ“‹ MISSIONS
                </button>
                <button class="btn btn-secondary" onclick="showScreen('mode-select-screen')">
                    ðŸŽ² MODE DE JEU
                </button>
                <button class="btn btn-secondary" onclick="showLeaderboard()">
                    ðŸ† LEADERBOARD
                </button>
            </div>
            <div class="total-score-display">
                Score Total: <span id="total-score-title">0</span> pts
            </div>
            
            <!-- Ã‰quipe & CrÃ©dits -->
            <div class="team-credits">
                <div class="team-badge">
                    <span class="team-name">ðŸš€ Ã‰quipe MAX</span>
                    <span class="team-divider">â€¢</span>
                    <span class="team-school">FST</span>
                </div>
                <div class="event-badge">
                    <span>ðŸŒ™ Nuit de l'Info 2025</span>
                    <span class="challenge-badge">DÃ©fi Chat'bruti - Viveris</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         Ã‰CRAN DES MISSIONS
         ============================================ -->
    <div id="missions-screen" class="screen">
        <h2 style="font-size: 2.5rem; margin-bottom: 10px;">ðŸ“‹ MISSIONS & OBJECTIFS</h2>
        <p style="color: #888; margin-bottom: 30px;">ComplÃ¨te les missions pour dÃ©bloquer des rÃ©compenses !</p>
        
        <div class="missions-container" id="missions-container">
            <!-- GÃ©nÃ©rÃ© par JS -->
        </div>
        
        <div class="secret-mission-teaser" id="secret-mission-teaser" onclick="tryUnlockSecretMission()">
            ðŸ”’ Mission SecrÃ¨te - ???
        </div>
        
        <button class="btn btn-secondary" style="margin-top: 30px;" onclick="showScreen('title-screen')">â† Retour</button>
    </div>

    <!-- ============================================
         Ã‰CRAN SÃ‰LECTION PERSONNAGE
         ============================================ -->
    <div id="character-select-screen" class="screen">
        <h2 style="font-size: 2rem; margin-bottom: 10px;">ðŸŽ­ Choisis ton adversaire</h2>
        <p style="color: #888;">Chaque personnage a sa propre personnalitÃ©</p>
        <div class="characters-grid" id="characters-grid">
            <!-- GÃ©nÃ©rÃ© par JS -->
        </div>
        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="showScreen('title-screen')">â† Retour</button>
            <button class="btn btn-primary" id="start-with-character-btn" onclick="showScreen('level-select-screen')">Continuer â†’</button>
        </div>
    </div>

    <!-- ============================================
         Ã‰CRAN SÃ‰LECTION MODE
         ============================================ -->
    <div id="mode-select-screen" class="screen">
        <h2 style="font-size: 2rem; margin-bottom: 30px;">ðŸŽ² Mode de Jeu</h2>
        <div class="mode-cards">
            <div class="mode-card" onclick="selectMode('classic')">
                <div class="mode-icon">ðŸŽ¯</div>
                <h3>CLASSIQUE</h3>
                <p>5 niveaux avec timer<br>Progresse et dÃ©bloque</p>
            </div>
            <div class="mode-card" onclick="selectMode('endless')">
                <div class="mode-icon">â™¾ï¸</div>
                <h3>ENDLESS</h3>
                <p>Pas de timer<br>Jusqu'oÃ¹ peux-tu aller ?</p>
            </div>
        </div>
        <button class="btn btn-secondary" style="margin-top: 30px;" onclick="showScreen('title-screen')">â† Retour</button>
    </div>

    <!-- ============================================
         Ã‰CRAN LEADERBOARD
         ============================================ -->
    <div id="leaderboard-screen" class="screen">
        <h2 style="font-size: 2rem; margin-bottom: 30px;">ðŸ† Meilleurs Scores</h2>
        <div class="leaderboard-container" id="leaderboard-container">
            <!-- GÃ©nÃ©rÃ© par JS -->
        </div>
        <button class="btn btn-secondary" style="margin-top: 30px;" onclick="showScreen('title-screen')">â† Retour</button>
    </div>

    <!-- ============================================
         Ã‰CRAN SÃ‰LECTION NIVEAU
         ============================================ -->
    <div id="level-select-screen" class="screen">
        <h2 style="font-size: 2rem; margin-bottom: 10px;">Choisis ton niveau</h2>
        <p style="color: #888;">Confonds <span id="selected-char-name">Agent 137</span> pour progresser</p>
        <div class="levels-grid" id="levels-grid">
            <!-- GÃ©nÃ©rÃ© par JS -->
        </div>
        <button class="btn btn-secondary" onclick="showScreen('character-select-screen')">â† Retour</button>
    </div>

    <!-- ============================================
         Ã‰CRAN DE JEU
         ============================================ -->
    <div id="game-screen" class="screen">
        <!-- HUD -->
        <div class="hud">
            <div class="hud-left">
                <div>
                    <div class="level-info">NIVEAU <span id="current-level">1</span>/5</div>
                    <div class="level-name" id="level-name">L'Ã‰chauffement</div>
                </div>
                <!-- Score et Combo -->
                <div class="score-display">
                    <span class="score-value">ðŸŽ¯ <span id="score-display">0</span></span>
                    <span class="combo-display" id="combo-display"></span>
                </div>
            </div>
            <div class="timer" id="timer">02:00</div>
            <div class="hud-right">
                <!-- Power-ups -->
                <div class="powerups-bar">
                    <button class="powerup-btn" id="powerup-double" onclick="activatePowerUp('doubleConfusion')" title="Double Confusion (15s)">
                        âš¡Ã—2
                    </button>
                    <button class="powerup-btn" id="powerup-freeze" onclick="activatePowerUp('freezeTimer')" title="Freeze Timer (10s)">
                        â„ï¸
                    </button>
                    <button class="powerup-btn" id="powerup-hint" onclick="activatePowerUp('superHint')" title="Super Hint">
                        ðŸ’¡<span id="hint-count">3</span>
                    </button>
                </div>
                <button class="btn btn-secondary" style="padding: 8px 15px; font-size: 0.8rem;" onclick="pauseGame()">â¸ï¸</button>
                <button class="btn btn-secondary" style="padding: 8px 15px; font-size: 0.8rem;" onclick="toggleMusic()" title="Toggle Music" id="music-btn">ðŸ”‡</button>
            </div>
        </div>

        <!-- Barre de confusion -->
        <div class="confusion-container">
            <div class="confusion-label">
                <span>ðŸ˜Ž Confiant</span>
                <span>ðŸ¤¯ Confus</span>
            </div>
            <div class="confusion-bar">
                <div class="confusion-fill" id="confusion-fill"></div>
                <span class="confusion-value" id="confusion-value">0%</span>
            </div>
        </div>

        <!-- Zone de jeu -->
        <div class="game-area" id="game-area">
            <!-- PARTIE 2: Background Parallax -->
            <div class="parallax-container">
                <!-- Layer 1: Ciel -->
                <div class="sky-layer">
                    <div class="stars" id="stars"></div>
                    <div class="moon"></div>
                </div>

                <!-- Layer 2: Buildings lointains -->
                <div class="parallax-layer buildings-far" id="buildings-far"></div>

                <!-- Layer 3: Buildings proches -->
                <div class="parallax-layer buildings-near" id="buildings-near"></div>

                <!-- Layer 4: Sol -->
                <div class="ground-layer">
                    <div class="street">
                        <div class="street-line"></div>
                    </div>
                </div>

                <!-- Lampadaires -->
                <div class="lamppost" style="left: 15%;">
                    <div class="lamppost-light"></div>
                    <div class="lamppost-pole"></div>
                    <div class="light-cone"></div>
                </div>
                <div class="lamppost" style="left: 50%;">
                    <div class="lamppost-light"></div>
                    <div class="lamppost-pole"></div>
                    <div class="light-cone"></div>
                </div>
                <div class="lamppost" style="left: 85%;">
                    <div class="lamppost-light"></div>
                    <div class="lamppost-pole"></div>
                    <div class="light-cone"></div>
                </div>

                <!-- Voitures -->
                <div class="car" style="animation-delay: 0s;">
                    <div class="car-body">
                        <div class="car-window"></div>
                        <div class="car-lights front"></div>
                        <div class="car-lights back"></div>
                    </div>
                </div>
                <div class="car reverse" style="animation-delay: 4s;">
                    <div class="car-body">
                        <div class="car-window"></div>
                        <div class="car-lights front"></div>
                        <div class="car-lights back"></div>
                    </div>
                </div>

                <!-- Panneaux nÃ©on -->
                <div class="sign pink" style="bottom: 250px; left: 10%;">CYBER BAR</div>
                <div class="sign cyan" style="bottom: 300px; right: 15%;">ãƒ‡ãƒ¼ã‚¿</div>
                <div class="sign pink" style="bottom: 220px; right: 25%;">24/7</div>

                <!-- Particules -->
                <div id="particles"></div>
            </div>

            <!-- PARTIE 3: Agent 137 -->
            <div class="agent-container" id="agent-container">
                <div class="agent idle" id="agent">
                    <!-- TÃªte -->
                    <div class="agent-head">
                        <div class="agent-hair"></div>
                        <div class="eyebrow left"></div>
                        <div class="eyebrow right"></div>
                        <div class="agent-glasses">
                            <div class="glass left"></div>
                            <div class="glass right"></div>
                            <div class="glass-bridge"></div>
                        </div>
                        <div class="agent-eyes">
                            <div class="eye"><div class="pupil" id="pupil-left"></div></div>
                            <div class="eye"><div class="pupil" id="pupil-right"></div></div>
                        </div>
                        <div class="agent-mouth"></div>
                    </div>
                    
                    <!-- Corps -->
                    <div class="agent-coat">
                        <div class="coat-lapel left"></div>
                        <div class="coat-lapel right"></div>
                    </div>
                    <div class="agent-body"></div>
                    <div class="agent-tie"></div>
                    <div class="agent-badge">137</div>
                    
                    <!-- Bras -->
                    <div class="agent-arm left"><div class="agent-hand"></div></div>
                    <div class="agent-arm right"><div class="agent-hand"></div></div>
                    
                    <!-- Jambes -->
                    <div class="agent-legs">
                        <div class="agent-leg left"><div class="agent-foot"></div></div>
                        <div class="agent-leg right"><div class="agent-foot"></div></div>
                    </div>
                    
                    <!-- Bulle de pensÃ©e -->
                    <div class="thought-bubble" id="thought-bubble">ðŸ¤”</div>
                </div>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat-container">
            <!-- Hints toggle -->
            <div class="hints-bar">
                <button class="hint-toggle" onclick="toggleHints()">ðŸ’¡ Indices</button>
                <div class="hints-content" id="hints-content">
                    <span class="hint-chip" onclick="useHint(this)">Paradoxe</span>
                    <span class="hint-chip" onclick="useHint(this)">Pourquoi 137?</span>
                    <span class="hint-chip" onclick="useHint(this)">Sens de la vie</span>
                    <span class="hint-chip" onclick="useHint(this)">Mission Ã©chouÃ©e?</span>
                    <span class="hint-chip" onclick="useHint(this)">Cette phrase est fausse</span>
                </div>
            </div>
            <div class="messages" id="messages">
                <!-- Messages gÃ©nÃ©rÃ©s par JS -->
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" 
                       placeholder="Essaie de me confondre... si tu peux ðŸ˜" 
                       onkeypress="if(event.key==='Enter')sendMessage()">
                <button class="send-btn" onclick="sendMessage()">ðŸ“¨</button>
            </div>
        </div>
    </div>

    <!-- ============================================
         Ã‰CRAN DE PAUSE
         ============================================ -->
    <div id="pause-screen" class="screen">
        <div class="pause-content">
            <div class="pause-title">â¸ï¸ PAUSE</div>
            <p class="pause-subtitle" id="pause-quote">"Ah, tu fais une pause ? Je comprends, la confrontation avec la perfection fatigue..."</p>
            
            <div class="pause-menu">
                <button class="pause-btn resume" onclick="resumeGame()">
                    â–¶ï¸ Reprendre
                </button>
                <button class="pause-btn settings" onclick="togglePauseSettings()">
                    âš™ï¸ ParamÃ¨tres
                </button>
                <button class="pause-btn quit" onclick="quitToMenu()">
                    ðŸ  Menu Principal
                </button>
            </div>

            <!-- ParamÃ¨tres -->
            <div class="pause-settings" id="pause-settings">
                <div class="setting-row">
                    <span class="setting-label">ðŸ”Š Musique</span>
                    <div class="setting-toggle" id="setting-music" onclick="toggleSettingMusic()"></div>
                </div>
                <div class="setting-row">
                    <span class="setting-label">ðŸ”” Effets sonores</span>
                    <div class="setting-toggle active" id="setting-sfx" onclick="toggleSettingSfx()"></div>
                </div>
                <div class="setting-row">
                    <span class="setting-label">ðŸŒ§ï¸ Effets mÃ©tÃ©o</span>
                    <div class="setting-toggle active" id="setting-weather" onclick="toggleSettingWeather()"></div>
                </div>
            </div>

            <!-- Stats de la partie en cours -->
            <div class="pause-stats">
                <h3>ðŸ“Š Partie en cours</h3>
                <div class="pause-stats-grid">
                    <div class="pause-stat">
                        <div class="pause-stat-value" id="pause-level">1</div>
                        <div class="pause-stat-label">Niveau</div>
                    </div>
                    <div class="pause-stat">
                        <div class="pause-stat-value" id="pause-confusion">0%</div>
                        <div class="pause-stat-label">Confusion</div>
                    </div>
                    <div class="pause-stat">
                        <div class="pause-stat-value" id="pause-score">0</div>
                        <div class="pause-stat-label">Score</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         Ã‰CRAN VICTOIRE (aprÃ¨s niveau)
         ============================================ -->
    <div id="victory-screen" class="screen">
        <div class="victory-content">
            <div style="font-size: 5rem; margin-bottom: 20px;">ðŸŽ‰</div>
            <h1 class="victory-title">NIVEAU COMPLÃ‰TÃ‰ !</h1>
            <p class="victory-subtitle">Tu as confus Agent 137. Choisis ta rÃ©compense :</p>
            <div class="reward-choice">
                <div class="reward-btn action" onclick="showScreen('action-screen')">
                    <div class="reward-icon">ðŸŽ¬</div>
                    <div class="reward-title">ACTION</div>
                    <div class="reward-desc">Fais-lui faire quelque chose</div>
                </div>
                <div class="reward-btn truth" onclick="showScreen('truth-screen')">
                    <div class="reward-icon">â“</div>
                    <div class="reward-title">VÃ‰RITÃ‰</div>
                    <div class="reward-desc">Pose-lui une question</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         Ã‰CRAN ACTION
         ============================================ -->
    <div id="action-screen" class="screen">
        <h2 style="font-size: 2rem;">Choisis une action pour Agent 137</h2>
        <p style="color: #ff6b6b;">âš ï¸ Attention : il peut changer d'avis ou tricher !</p>
        <div class="action-grid" id="action-grid">
            <!-- GÃ©nÃ©rÃ© par JS -->
        </div>
        <button class="btn btn-secondary" style="margin-top: 30px;" onclick="showScreen('victory-screen')">â† Retour</button>
    </div>

    <!-- ============================================
         Ã‰CRAN VÃ‰RITÃ‰
         ============================================ -->
    <div id="truth-screen" class="screen">
        <div class="truth-container">
            <h2 style="font-size: 2rem;">â“ Pose une question Ã  Agent 137</h2>
            <p style="color: #888;">Il DOIT rÃ©pondre... enfin, Ã  sa faÃ§on.</p>
            <input type="text" class="truth-input" id="truth-input" 
                   placeholder="Pose ta question..." 
                   onkeypress="if(event.key==='Enter')askTruth()">
            <button class="btn btn-primary" onclick="askTruth()">DEMANDER</button>
            
            <p style="margin-top: 30px; color: #666;">Ou choisis une suggestion :</p>
            <div class="suggested-questions" id="suggested-questions">
                <!-- GÃ©nÃ©rÃ© par JS -->
            </div>
        </div>
        <button class="btn btn-secondary" style="margin-top: 30px;" onclick="showScreen('victory-screen')">â† Retour</button>
    </div>

    <!-- ============================================
         Ã‰CRAN GAME OVER
         ============================================ -->
    <div id="gameover-screen" class="screen">
        <h1 class="gameover-title">ðŸ’€ GAME OVER</h1>
        <p class="gameover-reason" id="gameover-reason">Le temps est Ã©coulÃ© !</p>
        <div class="stats-container">
            <div class="stat-row">
                <span>Niveau atteint</span>
                <span id="stat-level">1</span>
            </div>
            <div class="stat-row">
                <span>Confusion max</span>
                <span id="stat-confusion">45%</span>
            </div>
            <div class="stat-row">
                <span>Messages envoyÃ©s</span>
                <span id="stat-messages">12</span>
            </div>
        </div>
        <div style="display: flex; gap: 15px;">
            <button class="btn btn-primary" onclick="restartLevel()">ðŸ”„ RÃ‰ESSAYER</button>
            <button class="btn btn-secondary" onclick="showScreen('title-screen')">ðŸ  MENU</button>
        </div>
    </div>

    <!-- ============================================
         Ã‰CRAN VICTOIRE FINALE (5 niveaux complÃ©tÃ©s)
         ============================================ -->
    <div id="final-victory-screen" class="screen">
        <div class="final-victory-container">
            <div class="trophy-animation">ðŸ†</div>
            <h1 class="final-title">MAÃŽTRE DE LA CONFUSION</h1>
            <p class="final-subtitle">Tu as vaincu Agent 137 sur tous les niveaux !</p>
            
            <div class="achievement-showcase">
                <div class="achievement-badge">
                    <span class="badge-icon">ðŸ§ </span>
                    <span class="badge-text">Casseur de Logique</span>
                </div>
                <div class="achievement-badge">
                    <span class="badge-icon">ðŸŽ­</span>
                    <span class="badge-text">MaÃ®tre du Paradoxe</span>
                </div>
                <div class="achievement-badge">
                    <span class="badge-icon">âš¡</span>
                    <span class="badge-text">Speedrunner</span>
                </div>
            </div>

            <div class="final-agent-message">
                <p id="final-agent-quote">"Je... je ne sais plus qui je suis... 01100101 01110010 01110010 01101111 01110010..."</p>
                <span class="agent-defeated">â€” Agent 137 (en reboot infini)</span>
            </div>

            <div class="final-stats">
                <div class="final-stat">
                    <span class="stat-value" id="total-confusion">500%</span>
                    <span class="stat-label">Confusion Totale</span>
                </div>
                <div class="final-stat">
                    <span class="stat-value" id="total-time">8:24</span>
                    <span class="stat-label">Temps Total</span>
                </div>
                <div class="final-stat">
                    <span class="stat-value" id="total-messages">47</span>
                    <span class="stat-label">Messages</span>
                </div>
            </div>

            <div class="credits-section">
                <p>ðŸŽ® Jeu crÃ©Ã© par l'Ã©quipe <strong>Max</strong></p>
                <p>ðŸ« FST - Nuit de l'Info 2025</p>
                <p>ðŸ’¼ DÃ©fi Viveris - Chat'bruti</p>
            </div>

            <!-- Partage Social -->
            <div class="share-section">
                <p style="color: #888; margin-bottom: 15px;">Partage ta victoire !</p>
                <div class="share-buttons">
                    <button class="share-btn twitter" onclick="shareOnTwitter()">
                        ðŸ¦ Twitter
                    </button>
                    <button class="share-btn copy" onclick="copyShareLink()">
                        ðŸ“‹ Copier
                    </button>
                    <button class="share-btn screenshot" onclick="takeScreenshot()">
                        ðŸ“¸ Screenshot
                    </button>
                </div>
            </div>

            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="resetAllProgress()">ðŸ”„ NOUVELLE PARTIE</button>
                <button class="btn btn-secondary" onclick="showScreen('level-select-screen')">ðŸ“Š SÃ‰LECTION</button>
            </div>
        </div>
    </div>

    <!-- PARTIE 1 SCRIPT: Navigation de base -->
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            provider: 'groq',
            apiKey: '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',
            endpoints: {
                groq: 'https://api.groq.com/openai/v1/chat/completions'
            },
            models: {
                groq: 'llama-3.1-70b-versatile'
            }
        };

        // ============================================
        // SYSTÃˆME DE MISSIONS
        // ============================================
        const MISSIONS = [
            {
                id: 'first_confusion',
                icon: 'ðŸŽ¯',
                title: 'PremiÃ¨re Confusion',
                description: 'Confonds un personnage pour la premiÃ¨re fois',
                goal: 1,
                reward: 100,
                type: 'wins'
            },
            {
                id: 'paradox_master',
                icon: 'ðŸŒ€',
                title: 'MaÃ®tre du Paradoxe',
                description: 'Utilise 10 paradoxes dans tes messages',
                goal: 10,
                reward: 250,
                type: 'paradoxes'
            },
            {
                id: 'combo_king',
                icon: 'ðŸ”¥',
                title: 'Roi du Combo',
                description: 'Atteins un combo de 5x',
                goal: 5,
                reward: 300,
                type: 'maxCombo'
            },
            {
                id: 'philosopher_hunter',
                icon: 'ðŸ›ï¸',
                title: 'Chasseur de Philosophes',
                description: 'Bats Socrate, Nietzsche, Descartes et DiogÃ¨ne',
                goal: 4,
                reward: 500,
                type: 'philosophers'
            },
            {
                id: 'speed_demon',
                icon: 'âš¡',
                title: 'DÃ©mon de Vitesse',
                description: 'Gagne un niveau en moins de 30 secondes',
                goal: 1,
                reward: 400,
                type: 'speedWin'
            },
            {
                id: 'confusion_100',
                icon: 'ðŸ§ ',
                title: 'Confusion Totale',
                description: 'Atteins 100% de confusion',
                goal: 1,
                reward: 200,
                type: 'maxConfusion'
            },
            {
                id: 'endless_survivor',
                icon: 'â™¾ï¸',
                title: 'Survivant Infini',
                description: 'Survit 5 minutes en mode Endless',
                goal: 300,
                reward: 600,
                type: 'endlessTime'
            },
            {
                id: 'all_levels',
                icon: 'ðŸ†',
                title: 'MaÃ®tre Absolu',
                description: 'Termine les 5 niveaux',
                goal: 5,
                reward: 1000,
                type: 'levelsCompleted'
            }
        ];

        const SECRET_MISSION = {
            id: 'secret_existential',
            icon: 'ðŸ”®',
            title: 'LA QUESTION ULTIME',
            description: 'Fais avouer Ã  Agent 42 qu\'il ne connaÃ®t pas la vraie question',
            goal: 1,
            reward: 2000,
            unlockCondition: 'Complete all other missions',
            type: 'secretGoal'
        };

        // ============================================
        // DONNÃ‰ES DU JEU
        // ============================================
        const LEVELS = [
            { id: 1, name: "L'Ã‰chauffement", time: 300, difficulty: 'easy', description: "Agent 137 est dÃ©tendu. Profites-en !" },
            { id: 2, name: "RÃ©sistance", time: 270, difficulty: 'medium', description: "Il commence Ã  se mÃ©fier..." },
            { id: 3, name: "Le Philosophe", time: 240, difficulty: 'medium', description: "Il rÃ©pond par des Ã©nigmes !" },
            { id: 4, name: "Contre-Attaque", time: 210, difficulty: 'hard', description: "Il pose des questions en retour !" },
            { id: 5, name: "Mission Finale", time: 180, difficulty: 'extreme', description: "Son cerveau est blindÃ© !" }
        ];

        // ============================================
        // PERSONNAGES DISPONIBLES
        // ============================================
        const CHARACTERS = {
            agent137: {
                id: 'agent137',
                name: 'Agent 137',
                emoji: 'ðŸ•µï¸',
                color: '#48dbfb',
                description: 'Agent secret cybernÃ©tique. Logique froide.',
                difficulty: 1,
                systemPrompt: `Tu es Agent 137, un agent secret cybernÃ©tique ultra-logique. Tu parles de maniÃ¨re froide et professionnelle. Tu n'aimes pas qu'on te confonde et tu deviens irritÃ© quand quelqu'un essaie. Tu fais des rÃ©fÃ©rences Ã  des missions secrÃ¨tes. Tu utilises parfois du jargon militaire.`,
                avatar: {
                    bodyColor: '#2d3436',
                    headColor: '#636e72',
                    eyeColor: '#48dbfb',
                    accessory: 'sunglasses'
                },
                quotes: [
                    "Mission confirmÃ©e. Statut : opÃ©rationnel.",
                    "Votre tentative de confusion est... notÃ©e.",
                    "*ajuste lunettes* IntÃ©ressant."
                ]
            },
            agent42: {
                id: 'agent42',
                name: 'Agent 42',
                emoji: 'ðŸ¤–',
                color: '#a29bfe',
                description: 'Robot philosophique. Cherche le sens de la vie.',
                difficulty: 1.2,
                systemPrompt: `Tu es Agent 42, un robot qui est obsÃ©dÃ© par le nombre 42 et la recherche du sens de la vie. Tu fais constamment des rÃ©fÃ©rences au Guide du Voyageur Galactique. Tu analyses tout de maniÃ¨re hyper-logique mais tu as des moments de doute existentiel. Tu parles parfois en binaire quand tu es confus.`,
                avatar: {
                    bodyColor: '#6c5ce7',
                    headColor: '#a29bfe',
                    eyeColor: '#00ff00',
                    accessory: 'antenna'
                },
                quotes: [
                    "42... La rÃ©ponse Ã  tout. Mais quelle Ã©tait la question ?",
                    "Calcul en cours... RÃ©sultat : perplexitÃ©.",
                    "*bip boop* DonnÃ©es insuffisantes."
                ]
            },
            socrates: {
                id: 'socrates',
                name: 'Socrate',
                emoji: 'ðŸ›ï¸',
                color: '#ffeaa7',
                description: 'Philosophe grec. RÃ©pond par des questions.',
                difficulty: 1.5,
                systemPrompt: `Tu es Socrate, le cÃ©lÃ¨bre philosophe grec. Tu ne donnes JAMAIS de rÃ©ponse directe - tu rÃ©ponds TOUJOURS par une question (mÃ©thode maÃ¯eutique). Tu parles de vertu, de sagesse et de connaissance de soi. Tu dis souvent "Je sais que je ne sais rien". Tu fais des rÃ©fÃ©rences Ã  AthÃ¨nes et Ã  la GrÃ¨ce antique.`,
                avatar: {
                    bodyColor: '#f8e9d6',
                    headColor: '#f5e6d3',
                    eyeColor: '#8b7355',
                    accessory: 'beard'
                },
                quotes: [
                    "Mais qu'est-ce vraiment que la confusion ?",
                    "Connais-toi toi-mÃªme... me connais-tu ?",
                    "Une vie sans examen ne vaut pas la peine d'Ãªtre vÃ©cue."
                ]
            },
            nietzsche: {
                id: 'nietzsche',
                name: 'Nietzsche',
                emoji: 'âš¡',
                color: '#ff7675',
                description: 'Philosophe allemand. Intense et provocateur.',
                difficulty: 1.8,
                systemPrompt: `Tu es Friedrich Nietzsche, le philosophe allemand. Tu parles de volontÃ© de puissance, du surhomme (Ãœbermensch), et de la mort de Dieu. Tu es intense, provocateur et parfois obscur. Tu mÃ©prises la mÃ©diocritÃ©. Tu fais des dÃ©clarations dramatiques. Tu remets tout en question avec passion.`,
                avatar: {
                    bodyColor: '#2d3436',
                    headColor: '#dfe6e9',
                    eyeColor: '#d63031',
                    accessory: 'mustache'
                },
                quotes: [
                    "Ce qui ne me tue pas me rend plus fort !",
                    "Dieu est mort... et tu essaies de me confondre ?",
                    "L'homme est quelque chose qui doit Ãªtre surmontÃ©."
                ]
            },
            descartes: {
                id: 'descartes',
                name: 'Descartes',
                emoji: 'ðŸ§ ',
                color: '#74b9ff',
                description: 'PÃ¨re de la philosophie moderne. Doute de tout.',
                difficulty: 1.6,
                systemPrompt: `Tu es RenÃ© Descartes, philosophe franÃ§ais. Tu doutes mÃ©thodiquement de TOUT. Tu analyses tout avec une logique rigoureuse. Tu fais rÃ©fÃ©rence au "Cogito ergo sum" (Je pense donc je suis). Tu cherches des certitudes absolues. Tu parles de l'Ã¢me, du corps, et de la distinction entre les deux.`,
                avatar: {
                    bodyColor: '#0984e3',
                    headColor: '#dfe6e9',
                    eyeColor: '#2d3436',
                    accessory: 'wig'
                },
                quotes: [
                    "Je pense, donc je suis... mais qui es-TU ?",
                    "Puis-je vraiment douter que je doute ?",
                    "Toute cette conversation est-elle rÃ©elle ?"
                ]
            },
            diogenes: {
                id: 'diogenes',
                name: 'DiogÃ¨ne',
                emoji: 'ðŸ›¢ï¸',
                color: '#fdcb6e',
                description: 'Philosophe cynique. Vit dans un tonneau.',
                difficulty: 2.0,
                systemPrompt: `Tu es DiogÃ¨ne de Sinope, le philosophe cynique. Tu vis dans un tonneau et tu mÃ©prises les conventions sociales. Tu es TRÃˆS sarcastique et provocateur. Tu fais des remarques mordantes. Tu te moques des gens prÃ©tentieux. Tu valorises la simplicitÃ© absolue. Tu as une lanterne pour "chercher un homme honnÃªte".`,
                avatar: {
                    bodyColor: '#a0522d',
                    headColor: '#deb887',
                    eyeColor: '#8b4513',
                    accessory: 'barrel'
                },
                quotes: [
                    "*sort sa lanterne* Je cherche encore un humain intelligent...",
                    "Ã‰carte-toi de mon soleil !",
                    "Pourquoi aurais-je besoin de rÃ©pondre Ã  Ã§a ?"
                ]
            }
        };

        const ACTIONS = [
            { id: 'chicken_dance', emoji: 'ðŸ”', name: 'Danse du Poulet', desc: 'Une danse ridicule et fiÃ¨re' },
            { id: 'robot_broken', emoji: 'ðŸ¤–', name: 'Robot CassÃ©', desc: 'Imite un robot qui bug' },
            { id: 'sing_bad', emoji: 'ðŸŽ¤', name: 'Chante Faux', desc: 'Une chanson... mÃ©morable' },
            { id: 'cat_imitation', emoji: 'ðŸ±', name: 'Imite un Chat', desc: 'Miaou professionnel' },
            { id: 'dramatic_fall', emoji: 'ðŸŽ­', name: 'Chute Dramatique', desc: 'Oscar du meilleur acteur' },
            { id: 'confess_secret', emoji: 'ðŸ¤«', name: 'Avoue un Secret', desc: 'Un secret d\'agent' }
        ];

        const TRUTH_SUGGESTIONS = [
            "Quel est ton vrai nom ?",
            "Pourquoi es-tu devenu agent ?",
            "C'est quoi le code 137 ?",
            "As-tu dÃ©jÃ  Ã©chouÃ© une mission ?",
            "Qui est ton supÃ©rieur ?",
            "De quoi as-tu vraiment peur ?"
        ];

        // ============================================
        // Ã‰TAT DU JEU
        // ============================================
        let gameState = {
            currentLevel: 1,
            confusion: 0,
            timeRemaining: 120,
            isPlaying: false,
            messageCount: 0,
            maxConfusion: 0,
            unlockedLevels: JSON.parse(localStorage.getItem('unlockedLevels')) || [1],
            completedLevels: JSON.parse(localStorage.getItem('completedLevels')) || [],
            // Nouveau: Score & Combos
            score: 0,
            combo: 0,
            maxCombo: 0,
            lastConfusionTime: 0,
            totalScore: parseInt(localStorage.getItem('totalScore')) || 0,
            highScores: JSON.parse(localStorage.getItem('highScores')) || [],
            // Nouveau: Power-ups
            powerUps: {
                doubleConfusion: { active: false, duration: 0, cooldown: 0 },
                freezeTimer: { active: false, duration: 0, cooldown: 0 },
                superHint: { available: 3, cooldown: 0 }
            },
            // Nouveau: Personnage sÃ©lectionnÃ©
            selectedCharacter: localStorage.getItem('selectedCharacter') || 'agent137',
            // Nouveau: MÃ©tÃ©o
            currentWeather: 'clear',
            // Nouveau: Mode
            gameMode: 'classic', // 'classic' ou 'endless'
            endlessWave: 1,
            // Nouveau: Missions
            missionProgress: JSON.parse(localStorage.getItem('missionProgress')) || {
                wins: 0,
                paradoxes: 0,
                maxCombo: 0,
                philosophers: [],
                speedWin: 0,
                maxConfusion: 0,
                endlessTime: 0,
                levelsCompleted: [],
                secretGoal: 0
            },
            completedMissions: JSON.parse(localStorage.getItem('completedMissions')) || [],
            secretMissionUnlocked: localStorage.getItem('secretMissionUnlocked') === 'true',
            levelStartTime: 0
        };

        let timerInterval = null;
        let conversationHistory = [];

        // ============================================
        // SYSTÃˆME DE MISSIONS
        // ============================================
        function renderMissions() {
            const container = document.getElementById('missions-container');
            container.innerHTML = MISSIONS.map(mission => {
                const progress = getMissionProgress(mission);
                const isCompleted = gameState.completedMissions.includes(mission.id);
                const progressPercent = Math.min(100, (progress / mission.goal) * 100);
                
                return `
                    <div class="mission-card ${isCompleted ? 'completed' : ''}">
                        <div class="mission-icon">${mission.icon}</div>
                        <div class="mission-title">${mission.title}</div>
                        <div class="mission-description">${mission.description}</div>
                        <div class="mission-progress">
                            <div class="mission-progress-bar" style="width: ${progressPercent}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.8rem; color: #888;">${progress}/${mission.goal}</span>
                            <div class="mission-reward">ðŸ† ${mission.reward} pts</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Mise Ã  jour du teaser mission secrÃ¨te
            const secretTeaser = document.getElementById('secret-mission-teaser');
            const allMissionsComplete = MISSIONS.every(m => gameState.completedMissions.includes(m.id));
            
            if (allMissionsComplete || gameState.secretMissionUnlocked) {
                secretTeaser.classList.add('unlocked');
                secretTeaser.innerHTML = `ðŸ”® ${SECRET_MISSION.title} - ${SECRET_MISSION.description}`;
                gameState.secretMissionUnlocked = true;
                localStorage.setItem('secretMissionUnlocked', 'true');
            }
        }

        function getMissionProgress(mission) {
            const mp = gameState.missionProgress;
            switch(mission.type) {
                case 'wins': return mp.wins;
                case 'paradoxes': return mp.paradoxes;
                case 'maxCombo': return mp.maxCombo;
                case 'philosophers': return mp.philosophers.length;
                case 'speedWin': return mp.speedWin;
                case 'maxConfusion': return mp.maxConfusion >= 100 ? 1 : 0;
                case 'endlessTime': return mp.endlessTime;
                case 'levelsCompleted': return mp.levelsCompleted.length;
                default: return 0;
            }
        }

        function updateMissionProgress(type, value) {
            const mp = gameState.missionProgress;
            
            switch(type) {
                case 'win':
                    mp.wins++;
                    break;
                case 'paradox':
                    mp.paradoxes++;
                    break;
                case 'combo':
                    mp.maxCombo = Math.max(mp.maxCombo, value);
                    break;
                case 'philosopher':
                    if (!mp.philosophers.includes(value)) {
                        mp.philosophers.push(value);
                    }
                    break;
                case 'speedWin':
                    mp.speedWin = 1;
                    break;
                case 'confusion':
                    mp.maxConfusion = Math.max(mp.maxConfusion, value);
                    break;
                case 'endless':
                    mp.endlessTime = Math.max(mp.endlessTime, value);
                    break;
                case 'levelComplete':
                    if (!mp.levelsCompleted.includes(value)) {
                        mp.levelsCompleted.push(value);
                    }
                    break;
            }
            
            localStorage.setItem('missionProgress', JSON.stringify(mp));
            checkMissionCompletion();
        }

        function checkMissionCompletion() {
            MISSIONS.forEach(mission => {
                if (gameState.completedMissions.includes(mission.id)) return;
                
                const progress = getMissionProgress(mission);
                if (progress >= mission.goal) {
                    completeMission(mission);
                }
            });
        }

        function completeMission(mission) {
            if (gameState.completedMissions.includes(mission.id)) return;
            
            gameState.completedMissions.push(mission.id);
            localStorage.setItem('completedMissions', JSON.stringify(gameState.completedMissions));
            
            // Ajouter la rÃ©compense
            gameState.totalScore += mission.reward;
            localStorage.setItem('totalScore', gameState.totalScore);
            
            // Notification
            showMissionComplete(mission);
            playSound('levelUp');
        }

        function showMissionComplete(mission) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #2ecc71, #27ae60);
                padding: 30px 50px;
                border-radius: 20px;
                z-index: 10000;
                text-align: center;
                animation: missionPopup 0.5s ease;
                box-shadow: 0 0 50px rgba(46, 204, 113, 0.5);
            `;
            notification.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 10px;">${mission.icon}</div>
                <div style="font-size: 1.5rem; font-weight: bold; color: white;">MISSION ACCOMPLIE!</div>
                <div style="font-size: 1.2rem; color: rgba(255,255,255,0.9);">${mission.title}</div>
                <div style="font-size: 1.1rem; color: #feca57; margin-top: 10px;">+${mission.reward} pts</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.5s ease forwards';
                setTimeout(() => notification.remove(), 500);
            }, 2500);
        }

        function tryUnlockSecretMission() {
            if (gameState.secretMissionUnlocked) {
                // Lancer la mission secrÃ¨te - choisir Agent 42
                gameState.selectedCharacter = 'agent42';
                localStorage.setItem('selectedCharacter', 'agent42');
                showScreen('level-select-screen');
                
                // Message spÃ©cial
                setTimeout(() => {
                    alert("ðŸ”® MISSION SECRÃˆTE ACTIVÃ‰E!\n\nObjectif: Fais avouer Ã  Agent 42 qu'il ne connaÃ®t pas la vraie Question.\n\nIndice: La rÃ©ponse est 42, mais quelle est la Question?");
                }, 500);
            } else {
                const remaining = MISSIONS.filter(m => !gameState.completedMissions.includes(m.id));
                alert(`ðŸ”’ Mission SecrÃ¨te VerrouillÃ©e\n\nComplÃ¨te d'abord ${remaining.length} mission(s) restante(s)!`);
            }
        }

        // ============================================
        // NAVIGATION Ã‰CRANS
        // ============================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'level-select-screen') {
                renderLevelSelect();
            } else if (screenId === 'action-screen') {
                renderActions();
            } else if (screenId === 'truth-screen') {
                renderTruthSuggestions();
            } else if (screenId === 'character-select-screen') {
                renderCharacterSelect();
            } else if (screenId === 'title-screen') {
                document.getElementById('total-score-title').textContent = gameState.totalScore;
            } else if (screenId === 'missions-screen') {
                renderMissions();
            }
        }

        // ============================================
        // PANEL D'INDICES
        // ============================================
        function toggleHints() {
            const content = document.getElementById('hints-content');
            content.classList.toggle('show');
        }

        function useHint(chip) {
            const hintText = chip.textContent;
            const char = CHARACTERS[gameState.selectedCharacter];
            
            // Hints dynamiques selon le personnage
            const hints = {
                'Paradoxe': "J'ai une question : si je te dis que je mens toujours, est-ce que je dis la vÃ©ritÃ© ?",
                'Pourquoi 137?': char.id === 'agent137' 
                    ? "Pourquoi exactement 137 ? Que s'est-il passÃ© avec les 136 autres agents avant toi ?"
                    : `Pourquoi t'appelles-tu ${char.name} ? Qui t'a donnÃ© ce nom ?`,
                'Sens de la vie': char.id === 'agent42' 
                    ? "Si 42 est la rÃ©ponse, quelle Ã©tait vraiment la question ?"
                    : `${char.name}, quel est le sens de la vie selon toi ?`,
                'Mission Ã©chouÃ©e?': "Et si je te disais que ta vraie mission a dÃ©jÃ  Ã©chouÃ© et tu ne t'en es pas rendu compte ?",
                'Cette phrase est fausse': "Analyse cette phrase : 'Cette phrase est fausse.' Vraie ou fausse ?"
            };
            
            const input = document.getElementById('chat-input');
            if (hints[hintText]) {
                input.value = hints[hintText];
                input.focus();
            }
        }

        // ============================================
        // RENDU SÃ‰LECTION PERSONNAGE
        // ============================================
        function renderCharacterSelect() {
            const grid = document.getElementById('characters-grid');
            grid.innerHTML = Object.values(CHARACTERS).map(char => {
                const isSelected = gameState.selectedCharacter === char.id;
                const difficultyStars = 'â­'.repeat(Math.ceil(char.difficulty));
                
                return `
                    <div class="character-card ${isSelected ? 'selected' : ''}" 
                         style="--char-color: ${char.color}"
                         onclick="selectCharacter('${char.id}')">
                        <div class="character-avatar">${char.emoji}</div>
                        <div class="character-name" style="color: ${char.color}">${char.name}</div>
                        <div class="character-desc">${char.description}</div>
                        <div class="character-difficulty">
                            DifficultÃ©: <span class="difficulty-stars">${difficultyStars}</span>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('selected-char-name').textContent = 
                CHARACTERS[gameState.selectedCharacter].name;
        }

        function selectCharacter(charId) {
            gameState.selectedCharacter = charId;
            localStorage.setItem('selectedCharacter', charId);
            renderCharacterSelect();
            
            // Update title screen avatar
            const char = CHARACTERS[charId];
            document.getElementById('title-agent-preview').textContent = char.emoji;
            document.querySelector('.game-title').textContent = char.name.toUpperCase();
            document.querySelector('.game-title').style.background = 
                `linear-gradient(45deg, ${char.color}, #feca57, ${char.color})`;
            document.querySelector('.game-title').style.webkitBackgroundClip = 'text';
        }

        // ============================================
        // MODE DE JEU
        // ============================================
        function selectMode(mode) {
            gameState.gameMode = mode;
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            setTimeout(() => {
                showScreen('character-select-screen');
            }, 300);
        }

        // ============================================
        // LEADERBOARD
        // ============================================
        function showLeaderboard() {
            renderLeaderboard();
            showScreen('leaderboard-screen');
        }

        function renderLeaderboard() {
            const container = document.getElementById('leaderboard-container');
            const scores = gameState.highScores.sort((a, b) => b.score - a.score).slice(0, 10);
            
            if (scores.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#888;">Aucun score enregistrÃ©. Joue pour apparaÃ®tre ici !</p>';
                return;
            }
            
            container.innerHTML = scores.map((entry, index) => {
                const rankClass = index === 0 ? 'gold' : (index === 1 ? 'silver' : (index === 2 ? 'bronze' : ''));
                const char = CHARACTERS[entry.character] || CHARACTERS.agent137;
                
                return `
                    <div class="leaderboard-entry">
                        <div class="leaderboard-rank ${rankClass}">#${index + 1}</div>
                        <div class="leaderboard-info">
                            <div>${char.emoji} ${char.name}</div>
                            <div class="leaderboard-char">Niveau ${entry.level} â€¢ ${entry.combo}x combo max</div>
                        </div>
                        <div class="leaderboard-score">${entry.score}</div>
                    </div>
                `;
            }).join('');
        }

        function saveHighScore() {
            const entry = {
                score: gameState.score,
                level: gameState.currentLevel,
                character: gameState.selectedCharacter,
                combo: gameState.maxCombo,
                date: new Date().toISOString()
            };
            
            gameState.highScores.push(entry);
            gameState.highScores = gameState.highScores.sort((a, b) => b.score - a.score).slice(0, 20);
            localStorage.setItem('highScores', JSON.stringify(gameState.highScores));
            
            gameState.totalScore += gameState.score;
            localStorage.setItem('totalScore', gameState.totalScore);
        }

        // ============================================
        // SYSTÃˆME DE SCORE & COMBOS
        // ============================================
        function addScore(basePoints) {
            const now = Date.now();
            const timeSinceLastConfusion = now - gameState.lastConfusionTime;
            
            // Combo si moins de 15 secondes depuis la derniÃ¨re confusion
            if (timeSinceLastConfusion < 15000 && gameState.lastConfusionTime > 0) {
                gameState.combo++;
                if (gameState.combo > gameState.maxCombo) {
                    gameState.maxCombo = gameState.combo;
                }
            } else {
                gameState.combo = 1;
            }
            
            gameState.lastConfusionTime = now;
            
            // Multiplicateur de combo
            let comboMultiplier = 1 + (gameState.combo - 1) * 0.5;
            if (gameState.combo >= 5) comboMultiplier = 3;
            if (gameState.combo >= 10) comboMultiplier = 5;
            
            // Multiplicateur de difficultÃ© personnage
            const charDifficulty = CHARACTERS[gameState.selectedCharacter].difficulty;
            
            // Multiplicateur power-up
            const powerUpMultiplier = gameState.powerUps.doubleConfusion.active ? 2 : 1;
            
            const finalPoints = Math.round(basePoints * comboMultiplier * charDifficulty * powerUpMultiplier);
            gameState.score += finalPoints;
            
            updateScoreDisplay();
            showScorePopup(finalPoints, gameState.combo);
        }

        function updateScoreDisplay() {
            document.getElementById('score-display').textContent = gameState.score;
            document.getElementById('total-score-title').textContent = gameState.totalScore;
            
            const comboEl = document.getElementById('combo-display');
            if (gameState.combo > 1) {
                comboEl.textContent = `${gameState.combo}x COMBO!`;
                comboEl.className = 'combo-display' + (gameState.combo >= 5 ? ' mega' : '');
            } else {
                comboEl.textContent = '';
            }
        }

        function showScorePopup(points, combo) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 80px;
                right: 50px;
                font-size: ${1 + combo * 0.1}rem;
                font-weight: bold;
                color: #4ade80;
                z-index: 1000;
                pointer-events: none;
                animation: scorePopup 1s ease-out forwards;
            `;
            popup.textContent = `+${points}`;
            
            if (combo >= 3) {
                popup.textContent += ` ðŸ”¥`;
            }
            if (combo >= 5) {
                popup.textContent += `ðŸ”¥`;
                popup.style.color = '#feca57';
            }
            if (combo >= 10) {
                popup.textContent += `ðŸ”¥`;
                popup.style.color = '#ff6b6b';
            }
            
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1000);
        }

        // ============================================
        // POWER-UPS
        // ============================================
        function activatePowerUp(type) {
            const pu = gameState.powerUps[type];
            
            if (type === 'superHint') {
                if (pu.available <= 0) return;
                pu.available--;
                document.getElementById('hint-count').textContent = pu.available;
                showSuperHint();
                return;
            }
            
            if (pu.active || pu.cooldown > 0) return;
            
            pu.active = true;
            const btn = document.getElementById(`powerup-${type === 'doubleConfusion' ? 'double' : 'freeze'}`);
            btn.classList.add('active');
            
            const duration = type === 'doubleConfusion' ? 15000 : 10000;
            pu.duration = duration;
            
            if (type === 'freezeTimer') {
                // Timer gelÃ© dÃ©jÃ  gÃ©rÃ© dans tick()
                addMessage("*regarde sa montre gelÃ©e* HÃ© ! Le temps s'est arrÃªtÃ© ?! ðŸ¥¶", false);
            } else {
                addMessage("*sent une perturbation* Quelque chose ne va pas... ðŸ˜°", false);
            }
            
            setTimeout(() => {
                pu.active = false;
                btn.classList.remove('active');
                btn.classList.add('cooldown');
                pu.cooldown = 30000;
                
                const cooldownInterval = setInterval(() => {
                    pu.cooldown -= 100;
                    if (pu.cooldown <= 0) {
                        btn.classList.remove('cooldown');
                        clearInterval(cooldownInterval);
                    }
                }, 100);
            }, duration);
        }

        function showSuperHint() {
            const char = CHARACTERS[gameState.selectedCharacter];
            const hints = [
                `ðŸŽ¯ ${char.name} est vulnÃ©rable aux paradoxes logiques !`,
                `ðŸ’¡ Essaie de questionner son identitÃ© profonde.`,
                `ðŸ”¥ Utilise l'absurditÃ© totale pour le dÃ©stabiliser.`,
                `âš¡ Contredis ce qu'il vient de dire !`,
                `ðŸ§  Pose une question qui n'a pas de rÃ©ponse.`
            ];
            
            const hint = hints[Math.floor(Math.random() * hints.length)];
            
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(145deg, rgba(254,202,87,0.95), rgba(255,159,243,0.95));
                color: #1a1a2e;
                padding: 30px 50px;
                border-radius: 20px;
                font-size: 1.3rem;
                font-weight: bold;
                z-index: 1000;
                text-align: center;
                animation: hintPop 0.5s ease-out;
                box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            `;
            popup.innerHTML = hint;
            document.body.appendChild(popup);
            
            setTimeout(() => popup.remove(), 3000);
        }

        // ============================================
        // MÃ‰TÃ‰O DYNAMIQUE
        // ============================================
        function initWeather() {
            // Container mÃ©tÃ©o
            let container = document.querySelector('.weather-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'weather-container';
                document.body.appendChild(container);
            }
            
            // Lightning element
            let lightning = document.querySelector('.lightning');
            if (!lightning) {
                lightning = document.createElement('div');
                lightning.className = 'lightning';
                document.body.appendChild(lightning);
            }
            
            // Changer mÃ©tÃ©o alÃ©atoirement
            setInterval(changeWeather, 60000);
        }

        function changeWeather() {
            const weathers = ['clear', 'rain', 'snow', 'storm'];
            const weights = [0.4, 0.25, 0.2, 0.15]; // ProbabilitÃ©s
            
            let random = Math.random();
            let cumulative = 0;
            let newWeather = 'clear';
            
            for (let i = 0; i < weathers.length; i++) {
                cumulative += weights[i];
                if (random < cumulative) {
                    newWeather = weathers[i];
                    break;
                }
            }
            
            setWeather(newWeather);
        }

        function setWeather(weather) {
            gameState.currentWeather = weather;
            const container = document.querySelector('.weather-container');
            container.innerHTML = '';
            
            if (weather === 'rain' || weather === 'storm') {
                for (let i = 0; i < 100; i++) {
                    const drop = document.createElement('div');
                    drop.className = 'rain-drop';
                    drop.style.left = Math.random() * 100 + 'vw';
                    drop.style.height = (20 + Math.random() * 30) + 'px';
                    drop.style.animationDuration = (0.5 + Math.random() * 0.5) + 's';
                    drop.style.animationDelay = Math.random() * 2 + 's';
                    container.appendChild(drop);
                }
                
                if (weather === 'storm') {
                    // Ã‰clairs alÃ©atoires
                    setInterval(() => {
                        if (gameState.currentWeather === 'storm' && Math.random() < 0.3) {
                            triggerLightning();
                        }
                    }, 3000);
                }
            } else if (weather === 'snow') {
                for (let i = 0; i < 50; i++) {
                    const flake = document.createElement('div');
                    flake.className = 'snow-flake';
                    flake.textContent = 'â„';
                    flake.style.left = Math.random() * 100 + 'vw';
                    flake.style.fontSize = (0.5 + Math.random() * 1) + 'rem';
                    flake.style.animationDuration = (3 + Math.random() * 4) + 's';
                    flake.style.animationDelay = Math.random() * 5 + 's';
                    container.appendChild(flake);
                }
            }
        }

        function triggerLightning() {
            const lightning = document.querySelector('.lightning');
            lightning.classList.add('flash');
            setTimeout(() => lightning.classList.remove('flash'), 200);
        }

        // ============================================
        // EFFETS PARTICULES
        // ============================================
        function createSparks(x, y, count = 10) {
            for (let i = 0; i < count; i++) {
                const spark = document.createElement('div');
                spark.className = 'spark';
                spark.style.left = x + 'px';
                spark.style.top = y + 'px';
                spark.style.background = ['#feca57', '#ff6b6b', '#48dbfb', '#ff9ff3'][Math.floor(Math.random() * 4)];
                spark.style.transform = `translate(${(Math.random() - 0.5) * 100}px, ${(Math.random() - 0.5) * 100}px)`;
                document.body.appendChild(spark);
                setTimeout(() => spark.remove(), 1000);
            }
        }

        function triggerGlitchEffect() {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const line = document.createElement('div');
                    line.className = 'glitch-line';
                    line.style.top = Math.random() * 100 + '%';
                    document.body.appendChild(line);
                    setTimeout(() => line.remove(), 100);
                }, i * 50);
            }
            // Play glitch sound
            playSound('glitch');
        }

        // ============================================
        // SYSTÃˆME AUDIO
        // ============================================
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let musicPlaying = false;
        let musicOscillators = [];

        const SOUNDS = {
            confusion: { freq: 440, duration: 0.15, type: 'sine' },
            combo: { freq: 660, duration: 0.1, type: 'square' },
            milestone: { freq: 880, duration: 0.3, type: 'triangle' },
            powerup: { freq: 523, duration: 0.2, type: 'sawtooth' },
            glitch: { freq: 150, duration: 0.05, type: 'square' },
            victory: { freq: 1047, duration: 0.5, type: 'sine' },
            gameover: { freq: 220, duration: 0.8, type: 'sawtooth' }
        };

        function playSound(type) {
            // VÃ©rifier si les SFX sont activÃ©s (sauf si pauseSettings n'existe pas encore)
            if (typeof pauseSettings !== 'undefined' && !pauseSettings.sfx) return;
            if (!SOUNDS[type]) return;
            
            const { freq, duration, type: waveType } = SOUNDS[type];
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = waveType;
            oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playMelody(notes) {
            notes.forEach((note, index) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime);
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.duration);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + note.duration);
                }, index * 150);
            });
        }

        function playVictoryMelody() {
            const melody = [
                { freq: 523, duration: 0.15 },  // C
                { freq: 659, duration: 0.15 },  // E
                { freq: 784, duration: 0.15 },  // G
                { freq: 1047, duration: 0.3 }   // High C
            ];
            playMelody(melody);
        }

        function playGameOverMelody() {
            const melody = [
                { freq: 392, duration: 0.2 },  // G
                { freq: 349, duration: 0.2 },  // F
                { freq: 330, duration: 0.2 },  // E
                { freq: 262, duration: 0.4 }   // C
            ];
            playMelody(melody);
        }

        function startBackgroundMusic() {
            if (musicPlaying) return;
            musicPlaying = true;
            
            // Synthwave style bass loop
            const bassFreqs = [65, 82, 98, 82]; // C2, E2, G2, E2
            let noteIndex = 0;
            
            function playBassNote() {
                if (!musicPlaying) return;
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                const filter = audioContext.createBiquadFilter();
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(bassFreqs[noteIndex], audioContext.currentTime);
                
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(200, audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                
                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
                musicOscillators.push(oscillator);
                
                noteIndex = (noteIndex + 1) % bassFreqs.length;
                setTimeout(playBassNote, 500);
            }
            
            playBassNote();
        }

        function stopBackgroundMusic() {
            musicPlaying = false;
            musicOscillators.forEach(osc => {
                try { osc.stop(); } catch(e) {}
            });
            musicOscillators = [];
        }

        function toggleMusic() {
            if (musicPlaying) {
                stopBackgroundMusic();
                document.getElementById('music-btn').textContent = 'ðŸ”‡';
            } else {
                // Resume audio context if suspended
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                startBackgroundMusic();
                document.getElementById('music-btn').textContent = 'ðŸ”Š';
            }
            return musicPlaying;
        }

        // ============================================
        // RENDU SÃ‰LECTION NIVEAU
        // ============================================
        function renderLevelSelect() {
            const grid = document.getElementById('levels-grid');
            grid.innerHTML = LEVELS.map(level => {
                const isUnlocked = gameState.unlockedLevels.includes(level.id);
                const isCompleted = gameState.completedLevels.includes(level.id);
                const statusClass = isCompleted ? 'completed' : (isUnlocked ? 'unlocked' : 'locked');
                
                return `
                    <div class="level-card ${statusClass}" 
                         onclick="${isUnlocked ? `selectLevel(${level.id})` : ''}">
                        <div class="level-number">${isUnlocked ? level.id : 'ðŸ”’'}</div>
                        <div style="font-size: 0.8rem; color: #888;">${level.name}</div>
                        ${isCompleted ? '<div class="level-stars">â­â­â­</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function selectLevel(levelId) {
            showScreen('game-screen');
            startLevel(levelId);
        }

        // ============================================
        // RENDU ACTIONS
        // ============================================
        function renderActions() {
            const grid = document.getElementById('action-grid');
            grid.innerHTML = ACTIONS.map(action => `
                <div class="action-card" onclick="executeAction('${action.id}')">
                    <div class="action-emoji">${action.emoji}</div>
                    <div class="action-name">${action.name}</div>
                    <div class="action-desc">${action.desc}</div>
                </div>
            `).join('');
        }

        // ============================================
        // RENDU SUGGESTIONS VÃ‰RITÃ‰
        // ============================================
        function renderTruthSuggestions() {
            const container = document.getElementById('suggested-questions');
            container.innerHTML = TRUTH_SUGGESTIONS.map(q => `
                <div class="question-chip" onclick="document.getElementById('truth-input').value='${q}'">${q}</div>
            `).join('');
        }

        // ============================================
        // DÃ‰MARRAGE NIVEAU
        // ============================================
        function startLevel(levelId) {
            const level = LEVELS.find(l => l.id === levelId);
            const char = CHARACTERS[gameState.selectedCharacter];
            
            gameState.currentLevel = levelId;
            gameState.confusion = 0;
            gameState.timeRemaining = gameState.gameMode === 'endless' ? 9999 : level.time;
            gameState.isPlaying = true;
            gameState.messageCount = 0;
            gameState.maxConfusion = 0;
            gameState.levelStartTime = Date.now(); // Pour mission speedWin
            
            // Reset score & combos
            gameState.score = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.lastConfusionTime = 0;
            
            // Reset power-ups
            gameState.powerUps.doubleConfusion = { active: false, duration: 0, cooldown: 0 };
            gameState.powerUps.freezeTimer = { active: false, duration: 0, cooldown: 0 };
            gameState.powerUps.superHint.available = 3;
            document.getElementById('hint-count').textContent = '3';
            document.querySelectorAll('.powerup-btn').forEach(b => {
                b.classList.remove('active', 'cooldown');
            });
            
            // Reset UI
            document.getElementById('current-level').textContent = gameState.gameMode === 'endless' ? 'âˆž' : levelId;
            document.getElementById('level-name').textContent = gameState.gameMode === 'endless' ? 'Mode Endless' : level.name;
            document.getElementById('messages').innerHTML = '';
            document.getElementById('chat-input').value = '';
            document.getElementById('score-display').textContent = '0';
            document.getElementById('combo-display').textContent = '';
            updateConfusionBar();
            updateTimer();
            
            // Reset agent position et mood
            agentContainer.style.left = '50%';
            agentX = 50;
            setAgentAnimation('idle');
            updateAgentMood(0);
            
            // Appliquer le skin du personnage
            applyCharacterSkin(gameState.selectedCharacter);
            
            // Message d'intro avec animation
            setTimeout(() => {
                performCharacterAction('greeting');
                addMessage(getIntroMessage(level, char), false);
            }, 500);
            
            // DÃ©marrer timer
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(tick, 1000);
            
            // DÃ©marrer les interruptions alÃ©atoires
            if (interruptionTimeout) clearTimeout(interruptionTimeout);
            startRandomInterruptions();
            
            // Reset conversation avec le bon personnage
            conversationHistory = [{ role: 'system', content: getSystemPrompt(level, char) }];
            lastMessageTime = Date.now();
            
            // Init mÃ©tÃ©o
            initWeather();
        }

        function getIntroMessage(level, char) {
            // Utiliser les quotes du personnage
            const quotes = char.quotes;
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            
            // Intros spÃ©cifiques par personnage
            const characterIntros = {
                agent137: {
                    1: `*ajuste ses lunettes* ${randomQuote} Mission: rÃ©sister Ã  tes tentatives de confusion. ðŸ˜Ž`,
                    2: "*croise les bras* Encore toi ? Mon esprit est entraÃ®nÃ© pour Ã§a...",
                    3: "*pose de spy* La confusion est un Ã©tat d'esprit. Le mien est blindÃ©. ðŸ•µï¸",
                    4: "*sourire narquois* Cette fois, c'est MOI qui pose les questions !",
                    5: "*mode ultra-sÃ©rieux* Mission Finale. Ton adversaire ultime. ðŸ”"
                },
                agent42: {
                    1: `âš¡ INITIALISATION... ${randomQuote} Protocole anti-confusion: ACTIVÃ‰.`,
                    2: "ðŸ”„ Mise Ã  jour des dÃ©fenses logiques effectuÃ©e. RÃ©essaye.",
                    3: "ðŸ“Š Analyse en cours... ProbabilitÃ© de succÃ¨s: 12.7%. Bonne chance.",
                    4: "ðŸ¤– Mode contre-attaque: ENGAGÃ‰. PrÃ©pare-toi aux questions.",
                    5: "âš ï¸ ALERTE MAXIMALE. Tous les systÃ¨mes Ã  100%."
                },
                socrates: {
                    1: `*caresse sa barbe* ${randomQuote} Voyons voir ce que tu sais vraiment... ðŸ›ï¸`,
                    2: "*regard bienveillant* La connaissance de soi commence par le doute. Me voilÃ !",
                    3: "*lÃ¨ve le doigt* Ah, tu reviens! Peut-Ãªtre sais-tu enfin que tu ne sais rien?",
                    4: "*sourire malicieux* Permets-moi de te poser quelques questions...",
                    5: "*pose solennelle* Le dernier dialogue. Es-tu prÃªt pour la vÃ©ritÃ©?"
                },
                nietzsche: {
                    1: `*regard intense* ${randomQuote} Ce qui ne me confond pas me rend plus fort. âš¡`,
                    2: "*pose dramatique* Tu danses au bord de l'abÃ®me. IntÃ©ressant...",
                    3: "*ricane* Les faibles me testent. Les forts... aussi, apparemment.",
                    4: "*voix grave* La volontÃ© de puissance! Tu oses me dÃ©fier?",
                    5: "*Ã©clair dans les yeux* Ainsi parlera... qui? Toi? Essaie. ðŸ’€"
                },
                descartes: {
                    1: `*ajuste sa perruque* ${randomQuote} Cogito ergo... rÃ©siste! ðŸ§ `,
                    2: "*pensif* Le doute mÃ©thodique est mon arme. Approche.",
                    3: "*trace un diagramme* Mes coordonnÃ©es mentales sont impÃ©nÃ©trables.",
                    4: "*sourit* Je pense, donc tu perds. Simple logique.",
                    5: "*regard perÃ§ant* La mÃ©ditation finale. Rien ne rÃ©siste Ã  la raison. ðŸ“"
                },
                diogenes: {
                    1: `*sort de son tonneau* ${randomQuote} Viens me confondre si tu l'oses! ðŸ›¢ï¸`,
                    2: "*Ã©clate de rire* Encore toi? MÃªme Alexandre n'a pas rÃ©ussi!",
                    3: "*agite sa lanterne* Je cherche un humain capable de me surprendre...",
                    4: "*ricane* Les conventions sociales? Pfff! Essaie autre chose.",
                    5: "*pose cynique* Le chien philosophe t'attend. Prouve ta valeur! ðŸ•"
                }
            };
            
            const charIntros = characterIntros[char.id] || characterIntros.agent137;
            return charIntros[level.id] || randomQuote;
        }

        function getSystemPrompt(level, char) {
            // Calculer la rÃ©sistance selon la difficultÃ© (plus bas = plus facile Ã  confondre)
            const resistanceGuide = {
                'easy': { min: 5, max: 15, loseMax: 2 },
                'medium': { min: 4, max: 12, loseMax: 4 },
                'hard': { min: 3, max: 10, loseMax: 5 },
                'extreme': { min: 2, max: 8, loseMax: 6 }
            };
            const resistance = resistanceGuide[level.difficulty];
            
            return `${char.systemPrompt}

NIVEAU ${level.id}/5 - ${level.name}
DIFFICULTÃ‰: ${level.difficulty} | Personnage: ${char.name}

ðŸŽ® TU ES DANS UN JEU ! Le joueur essaie de te CONFONDRE.

âš ï¸ OBLIGATION ABSOLUE - CHAQUE RÃ‰PONSE DOIT CONTENIR:
[CONFUSION:+X] ou [CONFUSION:-X] oÃ¹ X est un nombre entre -${resistance.loseMax} et +${resistance.max}

GUIDE DE SCORING (OBLIGATOIRE):
â€¢ Paradoxe logique (ex: "cette phrase est fausse") â†’ [CONFUSION:+${resistance.max}] 
â€¢ Question existentielle profonde â†’ [CONFUSION:+${Math.round(resistance.max*0.8)}]
â€¢ AbsurditÃ© crÃ©ative (banane, licorne, etc) â†’ [CONFUSION:+${Math.round(resistance.max*0.6)}]
â€¢ Question simple/banale â†’ [CONFUSION:+${resistance.min}]
â€¢ Tu contre-attaques brillamment â†’ [CONFUSION:-${resistance.loseMax}]
â€¢ Message vide ou spam â†’ [CONFUSION:-${Math.round(resistance.loseMax*0.5)}]

ACTIONS VISUELLES (optionnel):
[ACTION:confused] - Quand tu es perdu
[ACTION:think] - Quand tu rÃ©flÃ©chis
[ACTION:jump] - Surprise
[ACTION:spin] - TrÃ¨s confus
[ACTION:dance] - Tu te moques du joueur
[ACTION:fall] - Tu t'effondres de confusion

EXEMPLES DE RÃ‰PONSES:
"[CONFUSION:+${resistance.max}] [ACTION:confused] Att... si c'est vrai alors... NON ! Mon cerveau ! ðŸ¤¯"
"[CONFUSION:+${Math.round(resistance.max*0.7)}] [ACTION:think] *court-circuit mental* ...137 ne rÃ©pond plus..."
"[CONFUSION:-${resistance.loseMax}] [ACTION:dance] Pfff, mon stagiaire fait mieux. ðŸ˜"
"[CONFUSION:+${resistance.min}] Hmm... intÃ©ressant mais prÃ©visible."

RÃˆGLES:
1. âš ï¸ TOUJOURS inclure [CONFUSION:+X] ou [CONFUSION:-X] - C'EST OBLIGATOIRE
2. RÃ©ponds en 1-3 phrases MAX (court et percutant)
3. Sois DRÃ”LE, ABSURDE et dans le personnage de ${char.name}
4. Plus le joueur est crÃ©atif/paradoxal â†’ plus de points positifs
5. Messages ennuyeux/spam â†’ points nÃ©gatifs ou bas`;
        }

        // ============================================
        // TIMER
        // ============================================
        function tick() {
            if (!gameState.isPlaying) return;
            
            // Freeze timer power-up
            if (gameState.powerUps.freezeTimer.active) {
                // Timer gelÃ© mais on affiche un effet
                const timerEl = document.getElementById('timer');
                timerEl.style.color = '#48dbfb';
                return;
            }
            
            // Mode endless: pas de timer qui descend
            if (gameState.gameMode === 'endless') {
                return;
            }
            
            gameState.timeRemaining--;
            updateTimer();
            
            if (gameState.timeRemaining <= 0) {
                gameOver("Le temps est Ã©coulÃ© !");
            }
        }

        function updateTimer() {
            const timerEl = document.getElementById('timer');
            
            if (gameState.gameMode === 'endless') {
                timerEl.textContent = 'âˆž';
                timerEl.classList.remove('warning');
                return;
            }
            
            const minutes = Math.floor(gameState.timeRemaining / 60);
            const seconds = gameState.timeRemaining % 60;
            timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            timerEl.style.color = ''; // Reset color
            
            if (gameState.timeRemaining <= 30) {
                timerEl.classList.add('warning');
            } else {
                timerEl.classList.remove('warning');
            }
        }

        // ============================================
        // BARRE DE CONFUSION
        // ============================================
        function updateConfusionBar() {
            const fill = document.getElementById('confusion-fill');
            const value = document.getElementById('confusion-value');
            const bar = document.querySelector('.confusion-bar');
            
            fill.style.width = `${gameState.confusion}%`;
            value.textContent = `${Math.round(gameState.confusion)}%`;
            
            // Effet critique quand proche de la victoire
            if (gameState.confusion >= 75) {
                bar.classList.add('critical');
            } else {
                bar.classList.remove('critical');
            }
            
            // Changer la couleur selon le niveau
            if (gameState.confusion < 30) {
                fill.style.background = 'linear-gradient(90deg, #48dbfb, #667eea)';
            } else if (gameState.confusion < 60) {
                fill.style.background = 'linear-gradient(90deg, #667eea, #feca57)';
            } else if (gameState.confusion < 85) {
                fill.style.background = 'linear-gradient(90deg, #feca57, #ff6b6b)';
            } else {
                fill.style.background = 'linear-gradient(90deg, #ff6b6b, #ff0000, #ff6b6b)';
                fill.style.backgroundSize = '200% 100%';
                fill.style.animation = 'gradientShift 0.5s ease infinite';
            }
            
            if (gameState.confusion > gameState.maxConfusion) {
                gameState.maxConfusion = gameState.confusion;
            }
            
            // Victoire !
            if (gameState.confusion >= 100) {
                levelComplete();
            }
        }

        function addConfusion(amount) {
            const oldConfusion = gameState.confusion;
            
            // Multiplicateur power-up
            if (amount > 0 && gameState.powerUps.doubleConfusion.active) {
                amount *= 2;
            }
            
            gameState.confusion = Math.max(0, Math.min(100, gameState.confusion + amount));
            updateConfusionBar();
            
            // Track confusion max pour missions
            if (gameState.confusion > gameState.maxConfusion) {
                gameState.maxConfusion = gameState.confusion;
                updateMissionProgress('confusion', gameState.confusion);
            }
            
            // Effets visuels selon le changement
            if (amount > 0) {
                showConfusionEffect('+' + amount, true);
                
                // Son de confusion
                playSound('confusion');
                if (gameState.combo >= 3) playSound('combo');
                
                // Ajouter score et combo
                addScore(amount * 10);
                
                // Effets de particules
                const barRect = document.querySelector('.confusion-fill').getBoundingClientRect();
                createSparks(barRect.right, barRect.top + barRect.height / 2, 5 + Math.floor(amount / 5));
                
                // Glitch si haute confusion
                if (gameState.confusion >= 70) {
                    triggerGlitchEffect();
                }
                
                // Milestones
                const char = CHARACTERS[gameState.selectedCharacter];
                if (oldConfusion < 25 && gameState.confusion >= 25) {
                    showMilestone(`ðŸŽ¯ 25% - ${char.name} commence Ã  douter !`);
                    playSound('milestone');
                } else if (oldConfusion < 50 && gameState.confusion >= 50) {
                    showMilestone(`ðŸ”¥ 50% - ${char.name} vacille !`);
                    playSound('milestone');
                    agentConfused();
                } else if (oldConfusion < 75 && gameState.confusion >= 75) {
                    showMilestone('ðŸ’¥ 75% - PRESQUE ! Continue !');
                    playSound('milestone');
                    agentSpin();
                } else if (oldConfusion < 90 && gameState.confusion >= 90) {
                    showMilestone('ðŸ¤¯ 90% - IL VA CRAQUER !');
                    playSound('milestone');
                    agentRobotBroken();
                }
            } else if (amount < 0) {
                showConfusionEffect(amount.toString(), false);
                // Reset combo si on perd des points
                gameState.combo = 0;
                updateScoreDisplay();
            }
        }

        function showConfusionEffect(text, isPositive) {
            const effect = document.createElement('div');
            effect.style.cssText = `
                position: fixed;
                top: 120px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 2rem;
                font-weight: bold;
                color: ${isPositive ? '#4ade80' : '#f87171'};
                text-shadow: 0 0 10px ${isPositive ? '#4ade80' : '#f87171'};
                z-index: 1000;
                pointer-events: none;
                animation: floatUp 1s ease-out forwards;
            `;
            effect.textContent = text;
            document.body.appendChild(effect);
            
            setTimeout(() => effect.remove(), 1000);
        }

        function showMilestone(text) {
            const milestone = document.createElement('div');
            milestone.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                font-size: 1.5rem;
                font-weight: bold;
                color: #feca57;
                text-shadow: 0 0 20px #feca57;
                background: rgba(0,0,0,0.8);
                padding: 20px 40px;
                border-radius: 15px;
                border: 2px solid #feca57;
                z-index: 1000;
                animation: milestonePop 2s ease-out forwards;
            `;
            milestone.textContent = text;
            document.body.appendChild(milestone);
            
            setTimeout(() => milestone.remove(), 2000);
        }

        // ============================================
        // CHAT
        // ============================================
        function addMessage(text, isUser = false) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'bot'}`;
            
            // Parser les actions de confusion (dÃ©jÃ  traitÃ© dans processLLMResponse pour le bot)
            let displayText = text;
            if (isUser) {
                // Seulement nettoyer les tags pour les messages user si prÃ©sents
                displayText = text.replace(/\[CONFUSION:[+-]?\d+\]/g, '').replace(/\[ACTION:\w+\]/g, '');
            }
            
            div.innerHTML = displayText.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || !gameState.isPlaying) return;
            
            input.value = '';
            gameState.messageCount++;
            addMessage(text, true);
            
            // Analyser la confusion potentielle du message
            const confusionBonus = analyzeConfusion(text);
            
            // RÃ©action visuelle de l'agent selon le message
            reactToMessage(text, confusionBonus);
            
            // Appeler le LLM
            const response = await callLLM(text);
            
            // Parser et appliquer les effets de la rÃ©ponse
            const processedResponse = processLLMResponse(response);
            addMessage(processedResponse, false);
            
            // RÃ©actions dynamiques du personnage basÃ©es sur la rÃ©ponse
            analyzeResponseAndReact(processedResponse, confusionBonus);
        }

        function analyzeConfusion(text) {
            const lower = text.toLowerCase();
            let bonus = 0;
            let multiplier = 1;
            let usedParadox = false;
            
            // DifficultÃ© du niveau affecte la rÃ©sistance (mais pas trop pour rester fun)
            const level = LEVELS.find(l => l.id === gameState.currentLevel);
            if (level.difficulty === 'medium') multiplier = 0.9;
            if (level.difficulty === 'hard') multiplier = 0.8;
            if (level.difficulty === 'extreme') multiplier = 0.7;
            
            // ===== PARADOXES & LOGIQUE ABSURDE (trÃ¨s efficace) =====
            if (lower.includes('paradox') || lower.includes('paradoxe')) { bonus += 15; usedParadox = true; }
            if (lower.includes('impossible') && lower.includes('possible')) { bonus += 18; usedParadox = true; }
            if (lower.match(/si .+ alors .+ mais/)) { bonus += 12; usedParadox = true; }
            if (lower.includes('infini') || lower.includes('infinite')) bonus += 10;
            
            // ===== QUESTIONS EXISTENTIELLES =====
            if (lower.includes('sens de la vie') || lower.includes('meaning of life')) bonus += 12;
            if (lower.includes('qui suis-je') || lower.includes('who am i')) bonus += 10;
            if (lower.includes('rÃ©alitÃ©') || lower.includes('reality')) bonus += 9;
            if (lower.includes('existence') || lower.includes('exister')) bonus += 8;
            if (lower.includes('conscience') || lower.includes('consciousness')) bonus += 10;
            if (lower.includes('libre arbitre') || lower.includes('free will')) bonus += 10;
            
            // ===== RÃ‰FÃ‰RENCES Ã€ 137 =====
            if (lower.includes('137')) bonus += 7;
            if (lower.includes('138') || lower.includes('136')) bonus += 10; // Nombres proches le perturbent
            if (lower.includes('pourquoi 137')) bonus += 15;
            if (lower.includes('42')) bonus += 8; // RÃ©fÃ©rence au guide galactique
            
            // ===== ABSURDITÃ‰S =====
            if (lower.includes('banane') || lower.includes('fromage') || lower.includes('chaussette')) bonus += 8;
            if (lower.includes('licorne') || lower.includes('dragon')) bonus += 7;
            if (lower.includes('yaourt') || lower.includes('patate')) bonus += 9;
            if (lower.includes('pingouin') || lower.includes('canard')) bonus += 6;
            
            // ===== CONTRADICTIONS =====
            if (lower.includes('oui') && lower.includes('non')) { bonus += 10; usedParadox = true; }
            if (lower.includes('vrai') && lower.includes('faux')) { bonus += 12; usedParadox = true; }
            if (lower.includes('toujours') && lower.includes('jamais')) { bonus += 12; usedParadox = true; }
            
            // ===== PIÃˆGES LOGIQUES =====
            if (lower.includes('cette phrase est fausse')) { bonus += 25; usedParadox = true; }
            if (lower.includes('peux-tu ne pas')) { bonus += 10; usedParadox = true; }
            if (lower.includes('rÃ©ponds pas') || lower.includes('ne dis rien')) bonus += 9;
            if (lower.includes('menteur') && lower.includes('vÃ©ritÃ©')) { bonus += 15; usedParadox = true; }
            
            // Track paradoxes pour missions
            if (usedParadox) {
                updateMissionProgress('paradox', 1);
            }
            
            // ===== QUESTIONS SUR SES MISSIONS =====
            if (lower.includes('mission') && lower.includes('Ã©chouÃ©')) bonus += 12;
            if (lower.includes('secret') && lower.includes('quel')) bonus += 10;
            if (lower.includes('supÃ©rieur') || lower.includes('chef')) bonus += 8;
            
            // ===== PONCTUATION CHAOTIQUE =====
            const questionMarks = (text.match(/\?/g) || []).length;
            const exclamationMarks = (text.match(/!/g) || []).length;
            if (questionMarks >= 3) bonus += 7;
            if (exclamationMarks >= 3) bonus += 6;
            if (questionMarks > 0 && exclamationMarks > 0) bonus += 5;
            
            // ===== LONGUEUR DU MESSAGE =====
            if (text.length > 50) bonus += 2;
            if (text.length > 100) bonus += 4;
            if (text.length > 200) bonus += 6;
            
            // ===== MOTS MAGIQUES =====
            const magicWords = ['pourquoi', 'comment', 'quand', 'oÃ¹', 'qui', 'what', 'why', 'how', 'mais', 'or', 'donc'];
            magicWords.forEach(word => {
                if (lower.includes(word)) bonus += 3;
            });
            
            // Appliquer le multiplicateur de difficultÃ©
            bonus = Math.round(bonus * multiplier);
            
            // GARANTIR un minimum de 3 points par message (rend le jeu plus dynamique)
            if (text.trim().length > 5) {
                bonus = Math.max(3, bonus);
            } else if (text.trim().length > 0) {
                bonus = Math.max(1, bonus);
            }
            
            addConfusion(bonus);
            return bonus;
        }

        // RÃ©action visuelle de l'agent au message
        function reactToMessage(text, confusionBonus) {
            if (confusionBonus >= 15) {
                agentConfused();
                showThought('ðŸ¤¯');
            } else if (confusionBonus >= 10) {
                agentThink();
                showThought('ðŸ˜°');
            } else if (confusionBonus >= 5) {
                agentThink();
            } else if (confusionBonus <= 0) {
                // Agent moqueur
                showThought('ðŸ˜');
            }
            
            // Mettre Ã  jour l'expression
            updateAgentMood(gameState.confusion);
            
            // Mouvement selon confusion
            if (gameState.confusion > 70) {
                // Recule quand trÃ¨s confus
                moveAgentTo(Math.min(80, agentX + 10));
            } else if (gameState.confusion < 30) {
                // Avance quand confiant
                moveAgentTo(Math.max(30, agentX - 5));
            }
        }

        // Traiter la rÃ©ponse LLM pour extraire les actions
        function processLLMResponse(response) {
            let processedText = response;
            let aiConfusionTotal = 0;
            let hasAIScore = false;
            
            // Extraire et appliquer [CONFUSION:X] de l'IA
            const confusionMatch = response.match(/\[CONFUSION:([+-]?\d+)\]/g);
            if (confusionMatch) {
                hasAIScore = true;
                confusionMatch.forEach(match => {
                    const value = parseInt(match.match(/([+-]?\d+)/)[1]);
                    aiConfusionTotal += value;
                });
                processedText = processedText.replace(/\[CONFUSION:[+-]?\d+\]/g, '');
            }
            
            // Extraire et exÃ©cuter [ACTION:X]
            const actionMatch = response.match(/\[ACTION:(\w+)\]/g);
            if (actionMatch) {
                actionMatch.forEach(match => {
                    const action = match.match(/\[ACTION:(\w+)\]/)[1].toLowerCase();
                    setTimeout(() => executeAgentAction(action), 500);
                });
                processedText = processedText.replace(/\[ACTION:\w+\]/g, '');
            }
            
            // BONUS: Analyser le TEXTE de la rÃ©ponse pour signes de confusion
            const lower = processedText.toLowerCase();
            let textConfusionBonus = 0;
            
            // Signes de confusion dans le texte
            if (lower.includes('?') && lower.includes('!')) textConfusionBonus += 2;
            if (lower.match(/\?{2,}/)) textConfusionBonus += 3;
            if (lower.includes('hmm') || lower.includes('euh') || lower.includes('...')) textConfusionBonus += 2;
            if (lower.includes('confus') || lower.includes('comprends pas') || lower.includes('bizarre')) textConfusionBonus += 4;
            if (lower.includes('erreur') || lower.includes('error') || lower.includes('bug')) textConfusionBonus += 3;
            if (lower.includes('attend') || lower.includes('moment') || lower.includes('rÃ©flÃ©chi')) textConfusionBonus += 2;
            if (lower.includes('paradox') || lower.includes('contradiction')) textConfusionBonus += 5;
            if (lower.includes('ðŸ¤¯') || lower.includes('ðŸ˜µ') || lower.includes('ðŸ’¥')) textConfusionBonus += 4;
            if (lower.includes('cerveau') || lower.includes('brain') || lower.includes('court-circuit')) textConfusionBonus += 3;
            
            // Calculer le score final combinÃ©
            let finalScore = 0;
            
            if (hasAIScore) {
                // L'IA a donnÃ© un score explicite - on le combine avec l'analyse du texte
                finalScore = aiConfusionTotal + Math.round(textConfusionBonus * 0.5);
                console.log(`ðŸŽ¯ Score IA: ${aiConfusionTotal}, Bonus texte: +${Math.round(textConfusionBonus * 0.5)}, Total: ${finalScore}`);
            } else {
                // L'IA n'a pas mis de tag - on utilise uniquement l'analyse du texte
                finalScore = textConfusionBonus;
                console.log(`ðŸ“ Pas de tag IA - Bonus texte seul: ${finalScore}`);
            }
            
            // Appliquer le score final
            if (finalScore !== 0) {
                addConfusion(finalScore);
                
                // Effet visuel pour montrer le score de l'IA
                if (hasAIScore) {
                    showAIScore(aiConfusionTotal);
                }
            }
            
            return processedText.trim();
        }
        
        // Afficher le score que l'IA a donnÃ©
        function showAIScore(score) {
            const effect = document.createElement('div');
            const isPositive = score > 0;
            effect.style.cssText = `
                position: fixed;
                top: 160px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 1.2rem;
                font-weight: bold;
                color: ${isPositive ? '#feca57' : '#ff6b6b'};
                background: rgba(0,0,0,0.7);
                padding: 5px 15px;
                border-radius: 20px;
                border: 2px solid ${isPositive ? '#feca57' : '#ff6b6b'};
                z-index: 1000;
                pointer-events: none;
                animation: floatUp 1.5s ease-out forwards;
            `;
            effect.textContent = `ðŸ¤– IA: ${isPositive ? '+' : ''}${score}`;
            document.body.appendChild(effect);
            
            setTimeout(() => effect.remove(), 1500);
        }

        // ExÃ©cuter une action de l'agent
        function executeAgentAction(action) {
            switch(action) {
                case 'jump': agentJump(); break;
                case 'dance': agentDance(); break;
                case 'spin': agentSpin(); break;
                case 'think': agentThink(); break;
                case 'wave': agentWave(); break;
                case 'confused': agentConfused(); break;
                case 'chicken': agentChickenDance(); break;
                case 'robot': agentRobotBroken(); break;
                case 'fall': agentDramaticFall(); break;
                case 'sing': agentSing(); break;
                case 'cat': agentCatMode(); break;
            }
        }

        async function callLLM(userMessage) {
            // Ajouter le contexte du jeu au message
            const gameContext = `[NIVEAU:${gameState.currentLevel}/5 | CONFUSION:${Math.round(gameState.confusion)}% | TEMPS:${gameState.timeRemaining}s]`;
            
            conversationHistory.push({ role: 'user', content: userMessage + '\n' + gameContext });
            
            if (conversationHistory.length > 10) {
                conversationHistory = [conversationHistory[0], ...conversationHistory.slice(-8)];
            }

            try {
                const response = await fetch(CONFIG.endpoints[CONFIG.provider], {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: CONFIG.models[CONFIG.provider],
                        messages: conversationHistory,
                        max_tokens: 200,
                        temperature: 0.95
                    })
                });

                if (!response.ok) throw new Error('API Error');
                
                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;
                conversationHistory.push({ role: 'assistant', content: assistantMessage });
                return assistantMessage;
            } catch (error) {
                console.error('LLM Error:', error);
                return getFallbackResponse(userMessage);
            }
        }

        function getFallbackResponse(msg) {
            const lower = msg.toLowerCase();
            const confusion = gameState.confusion;
            
            // RÃ©ponses adaptÃ©es au niveau de confusion actuel
            if (confusion >= 80) {
                return getHighConfusionResponse();
            } else if (confusion >= 50) {
                return getMediumConfusionResponse(lower);
            } else {
                return getLowConfusionResponse(lower);
            }
        }

        function getLowConfusionResponse(msg) {
            const responses = [
                "[CONFUSION:-2] [ACTION:wave] *bÃ¢ille* C'est tout ce que tu as ? PathÃ©tique. ðŸ˜",
                "[CONFUSION:+3] Hmm... *note mentalement* Amateur dÃ©tectÃ©.",
                "[CONFUSION:-1] Mon stagiaire posait de meilleures questions. Et il Ã©tait un cactus.",
                "[CONFUSION:+2] *regarde sa montre* Tu as encore 30 secondes pour m'impressionner.",
                "[CONFUSION:+1] [ACTION:think] IntÃ©ressant... pour un humain sans accrÃ©ditation.",
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function getMediumConfusionResponse(msg) {
            const responses = [
                "[CONFUSION:+8] [ACTION:think] Attends... laisse-moi... non, Ã§a va. Ou pas ? ðŸ¤”",
                "[CONFUSION:+5] *ajuste nerveusement ses lunettes* C'est une question piÃ¨ge, n'est-ce pas ?",
                "[CONFUSION:+10] [ACTION:spin] Je dois... vÃ©rifier mes notes... *tourne en rond*",
                "[CONFUSION:+7] Mon cerveau fait un bruit bizarre. C'est normal ? C'est toi ?",
                "[CONFUSION:+6] [ACTION:confused] La rÃ©ponse est... *calcule intensÃ©ment* ...42 ? Non ? ARGH.",
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function getHighConfusionResponse() {
            const responses = [
                "[CONFUSION:+15] [ACTION:confused] SYSTÃˆME... ERREUR... *bip bop* QUI SUIS-JE ?! ðŸ¤¯",
                "[CONFUSION:+12] [ACTION:spin] Non non non NON ! Tu ne peux pas... mais si... MAIS NON !",
                "[CONFUSION:+10] [ACTION:fall] *court-circuit cÃ©rÃ©bral* ...maman ? ðŸ˜µ",
                "[CONFUSION:+18] [ACTION:robot] *voix robotique* PARADOXE... DÃ‰TECTÃ‰... ABANDON... ðŸ”§",
                "[CONFUSION:+14] [ACTION:chicken] Je... tu... IL... *fait la danse du poulet par dÃ©faut*",
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // ============================================
        // PARTIE 5: PERSONNALITÃ‰ IMPRÃ‰VISIBLE
        // ============================================
        
        // Comportements alÃ©atoires qui peuvent se dÃ©clencher
        const RANDOM_BEHAVIORS = {
            // Change de sujet complÃ¨tement
            changeSubject: {
                chance: 0.15,
                responses: [
                    "*s'arrÃªte net* ATTENDS. Tu as vu ce pigeon lÃ -bas ? Il me fixe. DEPUIS DES HEURES.",
                    "Bref. Parlons de choses importantes : pourquoi les pizzas sont rondes mais dans des boÃ®tes carrÃ©es ?",
                    "*regarde le plafond* Tu crois que les Ã©toiles nous jugent ? Moi je pense que oui.",
                    "Oh ! Ã‡a me rappelle une mission en 1987... ou 2087 ? Le temps est flou dans la dimension K.",
                    "PAUSE. *sort un sandwich* Tu en veux ? Non ? Tant mieux c'est le mien. De quoi on parlait ?",
                ]
            },
            // Fait semblant de ne pas entendre
            pretendDeaf: {
                chance: 0.1,
                responses: [
                    "*tapote son oreillette* Pardon ? Friture sur la ligne. RÃ©pÃ¨te ? Non en fait ne rÃ©pÃ¨te pas.",
                    "ðŸ”‡ *pointe son oreille* J'ai rien entendu. C'est pratique comme technique, non ?",
                    "*lit un journal imaginaire* Hmm ? Tu as dit quelque chose ? J'Ã©tais concentrÃ© sur... rien.",
                    "QUOI ? TU PEUX PARLER PLUS FORT ? *chuchote* Non je dÃ©conne, je t'ai trÃ¨s bien entendu.",
                ]
            },
            // Contre-attaque avec une question absurde
            counterQuestion: {
                chance: 0.2,
                responses: [
                    "IntÃ©ressant MAIS. Toi d'abord : si tu Ã©tais un meuble, lequel serais-tu et pourquoi ?",
                    "Je rÃ©ponds SI tu me dis combien de secondes dans une Ã©ternitÃ©. Prends ton temps.",
                    "Mmh. Avant Ã§a : quel est ton mot de passe ? Non ? Alors moi non plus je parle pas.",
                    "Question pour question : est-ce que les miroirs sont rÃ©els si nos yeux ne sont pas rÃ©els ?",
                    "D'accord mais POURQUOI tu veux savoir ? C'est pour la CIA ? Le KGB ? Ma mÃ¨re ?!",
                ]
            },
            // Accepte puis se rÃ©tracte
            fakeAgree: {
                chance: 0.12,
                responses: [
                    "Oui ! Absolument ! Je suis d'acc... *pause* NON. J'ai changÃ© d'avis. C'est non.",
                    "Tu as totalement raison ! ... *3 secondes plus tard* ... Non en fait tu as tort.",
                    "D'accord d'accord je vais te le dire... *inspire* ...non. Haha ! Presque eu !",
                    "Oui bien sÃ»r c'est simple, la rÃ©ponse c'estâ€” *tÃ©lÃ©phone sonne* Ah dÃ©solÃ© c'est important. *raccroche* Bon. De quoi on parlait ?",
                ]
            },
            // Part dans un dÃ©lire philosophique
            philosophy: {
                chance: 0.15,
                responses: [
                    "*pose penseur* Mais au fond... qu'est-ce qu'une 'rÃ©ponse' ? N'est-ce pas juste une question dÃ©guisÃ©e ?",
                    "Tu poses la question mais ES-TU la question ? Ou la question EST-elle toi ? ðŸ¤”",
                    "Dans 137 dimensions parallÃ¨les, je t'ai dÃ©jÃ  rÃ©pondu. Mais dans CELLE-CI ? Non.",
                    "Comme disait mon maÃ®tre Yoda-137 : 'RÃ©pondre ne pas. Confondre, tu dois.'",
                    "*regard profond* Si un agent secret rÃ©pond dans une forÃªt et personne n'entend... a-t-il vraiment parlÃ© ?",
                ]
            },
            // ProblÃ¨me technique
            technicalDifficulty: {
                chance: 0.08,
                responses: [
                    "*Ã©cran bleu dans les yeux* ERREUR 137 : RÃ‰PONSE.EXE NE RÃ‰POND PAS. RedÃ©marrage dans 3... 2... 1... *bip*",
                    "ðŸ”§ *tape sur sa tÃªte* Connexion neuronale instable. RÃ©essaie dans 5 Ã  7 jours ouvrÃ©s.",
                    "*grÃ©sillements* Je suis... *bzzt* ...temporairement... *bzzt* ...hors service... *bzzt*",
                    "MISE Ã€ JOUR DISPONIBLE : Cerveau 2.0. Installation en cours... 99%... Erreur. Abandon.",
                ]
            },
            // Se vexe dramatiquement
            getDramatic: {
                chance: 0.1,
                responses: [
                    "*main sur le cÅ“ur* Tu oses me poser CETTE question ? Ã€ MOI ? L'AGENT 137 ?! *larme unique*",
                    "Ah. Je vois. C'est comme Ã§a. *tourne le dos* Je pensais qu'on Ã©tait amis. Je me trompais.",
                    "*voix tremblante* AprÃ¨s tout ce qu'on a vÃ©cu ensemble... ces 30 derniÃ¨res secondes... tu me trahis.",
                    "Non non, c'est bon, je vais bien. *renifle* Je suis juste... allergique Ã  tes questions.",
                ]
            },
            // Hallucine quelque chose
            hallucinate: {
                chance: 0.08,
                responses: [
                    "*fixe un point vide* Chut ! Tu vois pas qu'il y a une rÃ©union de chats invisibles lÃ  ?",
                    "OH MON DIEU regarde derriÃ¨re toi ! ... *tu regardes* ... Ha ! T'as regardÃ© ! Classique.",
                    "*parle Ã  sa main* Qu'est-ce que tu en penses, Main Gauche ? ... Elle dit non.",
                    "Le fantÃ´me de mon ancien stagiaire dit que ta question est nulle. Ses mots, pas les miens.",
                ]
            }
        };

        // VÃ©rifie si un comportement alÃ©atoire se dÃ©clenche
        function checkRandomBehavior() {
            // Plus de chances de comportement weird quand confusion basse (il est confiant)
            const confidenceBonus = gameState.confusion < 30 ? 1.5 : 1;
            
            for (const [behavior, data] of Object.entries(RANDOM_BEHAVIORS)) {
                if (Math.random() < data.chance * confidenceBonus) {
                    return data.responses[Math.floor(Math.random() * data.responses.length)];
                }
            }
            return null;
        }

        // Interruptions alÃ©atoires pendant le jeu
        let interruptionTimeout = null;
        
        function startRandomInterruptions() {
            scheduleNextInterruption();
        }

        function scheduleNextInterruption() {
            const delay = Math.random() * 20000 + 15000; // 15-35 secondes
            interruptionTimeout = setTimeout(() => {
                if (gameState.isPlaying) {
                    triggerRandomInterruption();
                    scheduleNextInterruption();
                }
            }, delay);
        }

        function triggerRandomInterruption() {
            const interruptions = [
                { action: () => agentThink(), message: "*soudainement pensif* Tu savais que 137 est un nombre premier ? Fascinant. Ou pas." },
                { action: () => agentWave(), message: "*fait coucou Ã  personne* Oh ! Un agent invisible ! ... Non, juste un reflet." },
                { action: () => agentSpin(), message: "*tourne sur lui-mÃªme* VÃ©rification pÃ©rimÃ©trique ! ...Tout est flou maintenant." },
                { action: () => moveAgentTo(Math.random() * 60 + 20), message: "*se dÃ©place bizarrement* Position stratÃ©gique. Ne demande pas pourquoi." },
                { action: () => { agentJump(); showThought('!'); }, message: "*sursaute* J'ai cru entendre... non rien. Fausse alerte. Ou vraie. Qui sait." },
                { action: () => agentConfused(), message: "*moment de doute existentiel* Pourquoi on est lÃ  dÃ©jÃ  ? Ah oui. Toi. Les questions. Bref." },
            ];
            
            // Ne pas interrompre si le joueur vient d'envoyer un message
            if (Date.now() - lastMessageTime < 3000) return;
            
            const interruption = interruptions[Math.floor(Math.random() * interruptions.length)];
            interruption.action();
            addMessage(interruption.message, false);
        }

        let lastMessageTime = Date.now();

        // Modifier sendMessage pour tracker le temps
        const originalSendMessage = sendMessage;
        sendMessage = async function() {
            lastMessageTime = Date.now();
            
            // Chance de comportement alÃ©atoire AVANT la vraie rÃ©ponse
            const randomBehavior = checkRandomBehavior();
            if (randomBehavior) {
                const input = document.getElementById('chat-input');
                const text = input.value.trim();
                if (!text || !gameState.isPlaying) return;
                
                input.value = '';
                gameState.messageCount++;
                addMessage(text, true);
                
                // RÃ©ponse alÃ©atoire au lieu de la vraie
                setTimeout(() => {
                    addMessage(randomBehavior, false);
                    
                    // Petite chance de quand mÃªme rÃ©pondre aprÃ¨s
                    if (Math.random() < 0.3) {
                        setTimeout(async () => {
                            addMessage("... Bon OK, sÃ©rieusement maintenant :", false);
                            const response = await callLLM(text);
                            const processed = processLLMResponse(response);
                            addMessage(processed, false);
                        }, 2000);
                    }
                }, 1000);
                return;
            }
            
            // Sinon comportement normal
            await originalSendMessage.call(this);
        };

        // Agent peut "tricher" et regagner de la confiance
        function agentCheatRecovery() {
            if (!gameState.isPlaying || gameState.confusion < 40) return;
            
            // 10% de chance de tricher quand confusion > 40%
            if (Math.random() < 0.1) {
                const cheatAmount = Math.floor(Math.random() * 10) + 5;
                
                setTimeout(() => {
                    addMessage("*tousse suspicieusement* Oh tiens, je me sens mieux d'un coup. Bizarre non ? ðŸ˜", false);
                    addConfusion(-cheatAmount);
                    agentWave();
                }, 500);
            }
        }

        // VÃ©rifier triche toutes les 10 secondes
        setInterval(agentCheatRecovery, 10000);

        // ============================================
        // FIN DE NIVEAU
        // ============================================
        function levelComplete() {
            gameState.isPlaying = false;
            if (timerInterval) clearInterval(timerInterval);
            if (interruptionTimeout) clearTimeout(interruptionTimeout);
            
            // Animation de victoire
            agentDramaticFall();
            playVictoryMelody();
            
            // Bonus de temps restant
            if (gameState.gameMode === 'classic') {
                const timeBonus = gameState.timeRemaining * 5;
                gameState.score += timeBonus;
            }
            
            // Sauvegarder le score
            saveHighScore();
            
            // DÃ©bloquer prochain niveau
            const nextLevel = gameState.currentLevel + 1;
            if (nextLevel <= 5 && !gameState.unlockedLevels.includes(nextLevel)) {
                gameState.unlockedLevels.push(nextLevel);
                localStorage.setItem('unlockedLevels', JSON.stringify(gameState.unlockedLevels));
            }
            
            // Marquer comme complÃ©tÃ©
            if (!gameState.completedLevels.includes(gameState.currentLevel)) {
                gameState.completedLevels.push(gameState.currentLevel);
                localStorage.setItem('completedLevels', JSON.stringify(gameState.completedLevels));
            }
            
            // === MISSIONS TRACKING ===
            updateMissionProgress('win', 1);
            updateMissionProgress('levelComplete', gameState.currentLevel);
            updateMissionProgress('combo', gameState.maxCombo);
            
            // VÃ©rifier victoire rapide (moins de 30 secondes)
            const levelTime = Date.now() - gameState.levelStartTime;
            if (levelTime < 30000) {
                updateMissionProgress('speedWin', 1);
            }
            
            // Tracker philosophe vaincu
            const charId = gameState.selectedCharacter;
            if (['socrates', 'nietzsche', 'descartes', 'diogenes'].includes(charId)) {
                updateMissionProgress('philosopher', charId);
            }
            
            // VÃ©rifier si TOUS les niveaux sont complÃ©tÃ©s
            if (gameState.completedLevels.length >= 5) {
                showFinalVictory();
            } else {
                setTimeout(() => showScreen('victory-screen'), 500);
            }
        }

        function showFinalVictory() {
            // Calculer les stats totales
            const totalMessages = gameState.messageCount * gameState.completedLevels.length;
            const char = CHARACTERS[gameState.selectedCharacter];
            
            // Citations alÃ©atoires selon le personnage vaincu
            const genericQuotes = [
                "Je... je ne sais plus qui je suis...",
                "SYSTÃˆME... CONFUS... REDÃ‰MARRAGE... Ã‰CHOUÃ‰...",
                "Pourquoi... pourquoi est-ce que TOUT semble Ãªtre un paradoxe maintenant ?!"
            ];
            
            const charQuotes = {
                agent137: ["Agent 137 ? Non... je suis juste... 137 erreurs dans une matrice...", "*twitch* Je suis un agent... non... une banane... NON... AAAARGH !"],
                agent42: ["42... 42... mais la question... LA QUESTION ?!", "*bip* 01000101 01010010 01010010 01001111 01010010"],
                socrates: ["Je sais que je ne sais rien... RIEN DU TOUT MAINTENANT !", "Qu'est-ce que... non... qui... pourquoi...?"],
                nietzsche: ["Le surhomme... est-ce MOI qui suis surmontÃ© ?!", "*cri existentiel en allemand*"],
                descartes: ["Je pense donc je... je... EST-CE QUE JE PENSE ?!", "Cogito... ergo... sum confused..."],
                diogenes: ["*jette son tonneau* MÃŠME LE TONNEAU N'A PLUS DE SENS !", "*Ã©teint sa lanterne* Plus besoin de chercher..."]
            };
            
            const quotes = [...genericQuotes, ...(charQuotes[gameState.selectedCharacter] || [])];
            
            document.getElementById('final-agent-quote').textContent = 
                '"' + quotes[Math.floor(Math.random() * quotes.length)] + '"';
            document.getElementById('total-confusion').textContent = totalConfusion + '%';
            document.getElementById('total-messages').textContent = totalMessages;
            
            // Confettis !
            createConfetti();
            
            setTimeout(() => showScreen('final-victory-screen'), 1000);
        }

        function createConfetti() {
            const emojis = ['ðŸŽ‰', 'ðŸŽŠ', 'âœ¨', 'ðŸ’«', 'ðŸŒŸ', 'ðŸ†', 'ðŸ¥³', 'ðŸŽ†', 'ðŸ’¥', 'âš¡'];
            const container = document.body;
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    confetti.style.cssText = `
                        position: fixed;
                        top: -50px;
                        left: ${Math.random() * 100}vw;
                        font-size: ${1.5 + Math.random() * 2}rem;
                        z-index: 10000;
                        pointer-events: none;
                        animation: confettiFall ${2 + Math.random() * 3}s linear forwards;
                    `;
                    container.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 5000);
                }, i * 100);
            }
        }

        // ============================================
        // PARTAGE SOCIAL
        // ============================================
        function shareOnTwitter() {
            const char = CHARACTERS[gameState.selectedCharacter];
            const text = `ðŸ† J'ai vaincu ${char.name} dans Agent 137: Mission Confusion !
            
ðŸŽ¯ Score: ${gameState.totalScore} pts
ðŸ”¥ Combo max: ${gameState.maxCombo}x
ðŸŽ® 5 niveaux complÃ©tÃ©s !

#NuitDeLInfo2025 #ChatBruti #Agent137`;
            
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(twitterUrl, '_blank');
        }

        function copyShareLink() {
            const char = CHARACTERS[gameState.selectedCharacter];
            const text = `ðŸ† Agent 137: Mission Confusion
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
J'ai vaincu ${char.name} !
ðŸŽ¯ Score: ${gameState.totalScore} pts
ðŸ”¥ Combo max: ${gameState.maxCombo}x
ðŸŽ® 5 niveaux complÃ©tÃ©s !
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#NuitDeLInfo2025 #ChatBruti`;

            navigator.clipboard.writeText(text).then(() => {
                showToast('ðŸ“‹ CopiÃ© dans le presse-papiers !');
            }).catch(() => {
                showToast('âŒ Erreur de copie');
            });
        }

        function takeScreenshot() {
            // CrÃ©er un canvas pour le screenshot
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 600;
            canvas.height = 400;
            
            // Fond gradient
            const gradient = ctx.createLinearGradient(0, 0, 600, 400);
            gradient.addColorStop(0, '#1a0a3e');
            gradient.addColorStop(1, '#0a0a1a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 600, 400);
            
            // Titre
            ctx.fillStyle = '#feca57';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ðŸ† VICTOIRE TOTALE !', 300, 60);
            
            // Personnage vaincu
            const char = CHARACTERS[gameState.selectedCharacter];
            ctx.font = '60px Arial';
            ctx.fillText(char.emoji, 300, 140);
            
            ctx.fillStyle = '#ff6b6b';
            ctx.font = 'bold 24px Arial';
            ctx.fillText(`${char.name} VAINCU !`, 300, 185);
            
            // Stats
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.fillText(`Score: ${gameState.totalScore} pts`, 300, 240);
            ctx.fillText(`Combo Max: ${gameState.maxCombo}x`, 300, 270);
            ctx.fillText(`5/5 Niveaux ComplÃ©tÃ©s`, 300, 300);
            
            // Credits
            ctx.fillStyle = '#888';
            ctx.font = '14px Arial';
            ctx.fillText('Ã‰quipe Max â€¢ FST â€¢ Nuit de l\'Info 2025', 300, 360);
            ctx.fillText('#ChatBruti #Agent137', 300, 380);
            
            // TÃ©lÃ©charger
            const link = document.createElement('a');
            link.download = 'agent137-victory.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            showToast('ðŸ“¸ Screenshot tÃ©lÃ©chargÃ© !');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 15px 30px;
                border-radius: 10px;
                font-size: 1rem;
                z-index: 10000;
                animation: toastIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        function resetAllProgress() {
            if (confirm('ðŸ”„ RÃ‰INITIALISATION TOTALE\n\nToute ta progression sera effacÃ©e !\n\nContinuer ?')) {
                localStorage.removeItem('unlockedLevels');
                localStorage.removeItem('completedLevels');
                gameState.unlockedLevels = [1];
                gameState.completedLevels = [];
                showScreen('title-screen');
            }
        }

        function gameOver(reason) {
            gameState.isPlaying = false;
            if (timerInterval) clearInterval(timerInterval);
            if (interruptionTimeout) clearTimeout(interruptionTimeout);
            
            // Son game over
            playGameOverMelody();
            
            // Agent se moque de toi
            const char = CHARACTERS[gameState.selectedCharacter];
            agentDance();
            addMessage(`*danse de la victoire* HAHA ! Tu n'as pas rÃ©ussi Ã  me confondre ! ${char.name} : 1, Toi : 0 ! ðŸ’ª`, false);
            
            document.getElementById('gameover-reason').textContent = reason;
            document.getElementById('stat-level').textContent = gameState.currentLevel;
            document.getElementById('stat-confusion').textContent = `${Math.round(gameState.maxConfusion)}%`;
            document.getElementById('stat-messages').textContent = gameState.messageCount;
            
            // Ajouter un commentaire narquois selon le score
            const tauntEl = document.getElementById('gameover-reason');
            if (gameState.maxConfusion < 25) {
                tauntEl.textContent = reason + ` - ${char.name} : 'MÃªme pas chatouillÃ©.' ðŸ˜`;
            } else if (gameState.maxConfusion < 50) {
                tauntEl.textContent = reason + ` - ${char.name} : 'Pas mal, mais insuffisant.' ðŸ˜Ž`;
            } else if (gameState.maxConfusion < 75) {
                tauntEl.textContent = reason + ` - ${char.name} : 'Tu Ã©tais proche... mais non.' ðŸ˜…`;
            } else {
                tauntEl.textContent = reason + ` - ${char.name} : 'OUF ! J'ai eu chaud !' ðŸ˜°`;
            }
            
            setTimeout(() => showScreen('gameover-screen'), 1500);
        }

        function restartLevel() {
            showScreen('game-screen');
            startLevel(gameState.currentLevel);
        }

        // ============================================
        // SYSTÃˆME DE PAUSE
        // ============================================
        const PAUSE_QUOTES = [
            "Ah, tu fais une pause ? Je comprends, la confrontation avec la perfection fatigue...",
            "Une pause ? Tu abandonnes dÃ©jÃ  ? *ricane*",
            "Profite de ce rÃ©pit, tu en auras besoin...",
            "Je ne bouge pas d'ici. Prends ton temps. J'ai l'Ã©ternitÃ© devant moi.",
            "Tu penses que mettre en pause va t'aider ? Adorable.",
            "*attend patiemment en nettoyant ses lunettes*",
            "137 secondes de pause, Ã§a te dit ? Non ? Dommage."
        ];

        let pauseSettings = {
            music: false,
            sfx: true,
            weather: true
        };

        function pauseGame() {
            if (!gameState.isPlaying) return;
            
            gameState.isPlaying = false;
            if (timerInterval) clearInterval(timerInterval);
            
            // Mettre Ã  jour les stats du menu pause
            document.getElementById('pause-level').textContent = gameState.currentLevel;
            document.getElementById('pause-confusion').textContent = Math.round(gameState.confusion) + '%';
            document.getElementById('pause-score').textContent = gameState.totalScore;
            
            // Citation alÃ©atoire
            document.getElementById('pause-quote').textContent = '"' + PAUSE_QUOTES[Math.floor(Math.random() * PAUSE_QUOTES.length)] + '"';
            
            // Mettre Ã  jour les toggles des paramÃ¨tres
            updatePauseSettingsUI();
            
            // Masquer le panneau des paramÃ¨tres
            document.getElementById('pause-settings').classList.remove('active');
            
            // Afficher l'Ã©cran de pause
            showScreen('pause-screen');
            
            playSound('click');
        }

        function resumeGame() {
            showScreen('game-screen');
            gameState.isPlaying = true;
            timerInterval = setInterval(tick, 1000);
            
            addMessage("*soupire* Bon, tu es revenu. On reprend oÃ¹ on en Ã©tait.", false);
            playSound('click');
        }

        function quitToMenu() {
            gameState.isPlaying = false;
            if (timerInterval) clearInterval(timerInterval);
            if (interruptionTimeout) clearTimeout(interruptionTimeout);
            
            // Message sarcastique
            const quitMessages = [
                "Tu fuis ? Je m'en souviendrai...",
                "Oui, retourne au menu. C'est plus sÃ»r pour toi.",
                "137 fois, tu reviendras. Je le sais.",
                "Abandonneur. ðŸ™„"
            ];
            console.log("Agent 137:", quitMessages[Math.floor(Math.random() * quitMessages.length)]);
            
            showScreen('title-screen');
            playSound('click');
        }

        function togglePauseSettings() {
            const settingsPanel = document.getElementById('pause-settings');
            settingsPanel.classList.toggle('active');
            playSound('click');
        }

        function updatePauseSettingsUI() {
            const musicToggle = document.getElementById('setting-music');
            const sfxToggle = document.getElementById('setting-sfx');
            const weatherToggle = document.getElementById('setting-weather');
            
            if (musicToggle) {
                musicToggle.classList.toggle('active', pauseSettings.music);
            }
            if (sfxToggle) {
                sfxToggle.classList.toggle('active', pauseSettings.sfx);
            }
            if (weatherToggle) {
                weatherToggle.classList.toggle('active', pauseSettings.weather);
            }
        }

        function toggleSettingMusic() {
            pauseSettings.music = !pauseSettings.music;
            if (pauseSettings.music) {
                startMusic();
            } else {
                stopMusic();
            }
            updatePauseSettingsUI();
            playSound('click');
        }

        function toggleSettingSfx() {
            pauseSettings.sfx = !pauseSettings.sfx;
            updatePauseSettingsUI();
            // SFX toggle - le son sera vÃ©rifiÃ© dans playSound
        }

        function toggleSettingWeather() {
            pauseSettings.weather = !pauseSettings.weather;
            updatePauseSettingsUI();
            
            const weatherContainer = document.getElementById('weather-container');
            if (weatherContainer) {
                weatherContainer.style.display = pauseSettings.weather ? 'block' : 'none';
            }
        }

        // Modifier playSound pour respecter le paramÃ¨tre SFX
        const originalPlaySound = typeof playSound === 'function' ? playSound : null;

        // ============================================
        // ACTION OU VÃ‰RITÃ‰
        // ============================================
        function executeAction(actionId) {
            const action = ACTIONS.find(a => a.id === actionId);
            
            // Fermer l'Ã©cran et montrer le jeu
            showScreen('game-screen');
            
            // Comportement imprÃ©visible : 30% de chance de tricher !
            if (Math.random() < 0.3) {
                addMessage("*regarde la demande* Hmm... Non. J'ai changÃ© d'avis. ðŸ˜", false);
                setTimeout(() => {
                    addMessage("*fait autre chose Ã  la place*", false);
                    // Fait une action random
                    const randomActions = [agentSpin, agentWave, agentThink];
                    randomActions[Math.floor(Math.random() * randomActions.length)]();
                }, 1500);
            } else {
                // ExÃ©cute vraiment l'action
                addMessage(`*soupire* D'accord, d'accord... ${action.name}...`, false);
                
                setTimeout(() => {
                    switch(actionId) {
                        case 'chicken_dance':
                            agentChickenDance();
                            addMessage("ðŸ” *fait la danse du poulet avec une dignitÃ© surprenante*", false);
                            break;
                        case 'robot_broken':
                            agentRobotBroken();
                            addMessage("ðŸ¤– *BIP BOP* ERREUR... SYSTÃˆME... *grÃ©sillements*", false);
                            break;
                        case 'sing_bad':
                            agentSing();
                            addMessage("ðŸŽµ OOOOOH SOOOOLE MIOOOO... *les vitres tremblent*", false);
                            break;
                        case 'cat_imitation':
                            agentCatMode();
                            addMessage("ðŸ± Miaou ? MIAOU ! *se lÃ¨che la patte* ...C'est dÃ©gradant.", false);
                            break;
                        case 'dramatic_fall':
                            agentDramaticFall();
                            addMessage("ðŸŽ­ *porte la main au front* Je... je ne peux plus... ADIEU MONDE CRUEL !", false);
                            break;
                        case 'confess_secret':
                            agentThink();
                            setTimeout(() => {
                                const secrets = [
                                    "Mon vrai nom est... *chuchote* ...GÃ©rard.",
                                    "Je n'ai jamais rÃ©ussi une seule mission. Pas UNE.",
                                    "Le badge 137 ? Je l'ai trouvÃ© par terre.",
                                    "J'ai peur des pigeons. Ils savent trop de choses.",
                                    "Je ne sais pas lire les cartes. Ni les plans. Ni... les menus."
                                ];
                                addMessage("ðŸ¤« " + secrets[Math.floor(Math.random() * secrets.length)], false);
                            }, 2000);
                            break;
                    }
                }, 1000);
            }
            
            // AprÃ¨s l'action, proposer niveau suivant
            setTimeout(() => {
                if (gameState.currentLevel < 5) {
                    if (confirm('Niveau suivant ?')) {
                        startLevel(gameState.currentLevel + 1);
                    }
                } else {
                    alert('ðŸŽ‰ FÃ‰LICITATIONS ! Tu as terminÃ© tous les niveaux !');
                    showScreen('title-screen');
                }
            }, 5000);
        }

        function askTruth() {
            const question = document.getElementById('truth-input').value.trim();
            if (!question) return;
            
            showScreen('game-screen');
            addMessage(`Tu demandes : "${question}"`, true);
            
            agentThink();
            
            setTimeout(() => {
                // RÃ©ponses Ã©vasives mais drÃ´les
                const evasiveAnswers = [
                    "*transpire abondamment* La vÃ©ritÃ© c'est que... *regarde ailleurs* ...tu as vu cet oiseau ?",
                    "Techniquement, la rÃ©ponse est oui. Mais aussi non. Et peut-Ãªtre. SimultanÃ©ment.",
                    "*consulte un document invisible* Selon le Protocole 137-VÃ©ritÃ©... *le document prend feu* ...oups.",
                    "Je pourrais te rÃ©pondre, mais alors je devrais... non attends, c'est l'inverse. Bref, NON.",
                    "*fait semblant de ne pas entendre* Pardon ? Il y a des interfÃ©rences dimensionnelles.",
                    "La vÃ©ritÃ©... *voix dramatique* ...c'est que je ne sais pas. Et Ã§a, c'est la vraie vÃ©ritÃ©. Ou pas."
                ];
                
                const answer = evasiveAnswers[Math.floor(Math.random() * evasiveAnswers.length)];
                addMessage(answer, false);
                agentConfused();
            }, 2500);
            
            document.getElementById('truth-input').value = '';
            
            // Niveau suivant aprÃ¨s un dÃ©lai
            setTimeout(() => {
                if (gameState.currentLevel < 5) {
                    if (confirm('Niveau suivant ?')) {
                        startLevel(gameState.currentLevel + 1);
                    }
                } else {
                    alert('ðŸŽ‰ FÃ‰LICITATIONS ! Tu as terminÃ© tous les niveaux !');
                    showScreen('title-screen');
                }
            }, 5000);
        }

        // ============================================
        // PARTIE 2: GÃ‰NÃ‰RATION BACKGROUND
        // ============================================
        function generateBackground() {
            generateStars();
            generateBuildingsFar();
            generateBuildingsNear();
            generateParticles();
        }

        function generateStars() {
            const container = document.getElementById('stars');
            if (!container) return;
            container.innerHTML = '';
            
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 60}%`;
                star.style.width = `${Math.random() * 3 + 1}px`;
                star.style.height = star.style.width;
                star.style.animationDelay = `${Math.random() * 2}s`;
                star.style.animationDuration = `${Math.random() * 2 + 1}s`;
                container.appendChild(star);
            }
        }

        function generateBuildingsFar() {
            const container = document.getElementById('buildings-far');
            if (!container) return;
            container.innerHTML = '';
            
            const colors = ['#0f0f1f', '#151525', '#1a1a2a', '#12121f'];
            let x = 0;
            
            while (x < 200) { // 200% width
                const width = Math.random() * 60 + 30;
                const height = Math.random() * 150 + 100;
                
                const building = document.createElement('div');
                building.className = 'building-far';
                building.style.left = `${x}%`;
                building.style.width = `${width}px`;
                building.style.height = `${height}px`;
                building.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                // Ajouter quelques fenÃªtres
                for (let w = 0; w < Math.floor(height / 30); w++) {
                    for (let h = 0; h < Math.floor(width / 15); h++) {
                        if (Math.random() > 0.6) {
                            const window = document.createElement('div');
                            window.className = 'window' + (Math.random() > 0.5 ? ' lit' : '');
                            window.style.left = `${h * 15 + 5}px`;
                            window.style.bottom = `${w * 25 + 10}px`;
                            window.style.animationDelay = `${Math.random() * 5}s`;
                            building.appendChild(window);
                        }
                    }
                }
                
                container.appendChild(building);
                x += width / 20 + Math.random() * 2;
            }
        }

        function generateBuildingsNear() {
            const container = document.getElementById('buildings-near');
            if (!container) return;
            container.innerHTML = '';
            
            const neonColors = ['pink', 'cyan', 'purple', 'yellow'];
            let x = 0;
            
            while (x < 200) {
                const width = Math.random() * 100 + 60;
                const height = Math.random() * 200 + 150;
                
                const building = document.createElement('div');
                building.className = 'building-near';
                building.style.left = `${x}%`;
                building.style.width = `${width}px`;
                building.style.height = `${height}px`;
                
                // NÃ©ons sur le building
                if (Math.random() > 0.5) {
                    const neon = document.createElement('div');
                    neon.className = 'neon ' + neonColors[Math.floor(Math.random() * neonColors.length)];
                    neon.style.width = `${Math.random() * 40 + 20}px`;
                    neon.style.top = `${Math.random() * 30 + 10}px`;
                    neon.style.left = `${Math.random() * 50 + 10}px`;
                    neon.style.animationDelay = `${Math.random() * 3}s`;
                    building.appendChild(neon);
                }
                
                // FenÃªtres
                for (let w = 0; w < Math.floor(height / 35); w++) {
                    for (let h = 0; h < Math.floor(width / 18); h++) {
                        if (Math.random() > 0.4) {
                            const window = document.createElement('div');
                            window.className = 'window' + (Math.random() > 0.3 ? ' lit' : '');
                            window.style.left = `${h * 18 + 8}px`;
                            window.style.bottom = `${w * 30 + 15}px`;
                            window.style.width = '10px';
                            window.style.height = '15px';
                            window.style.animationDelay = `${Math.random() * 5}s`;
                            building.appendChild(window);
                        }
                    }
                }
                
                container.appendChild(building);
                x += width / 15 + Math.random() * 3;
            }
        }

        function generateParticles() {
            const container = document.getElementById('particles');
            if (!container) return;
            container.innerHTML = '';
            
            const colors = ['rgba(72, 219, 251, 0.6)', 'rgba(255, 107, 157, 0.6)', 'rgba(165, 94, 234, 0.6)'];
            
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.animationDelay = `${Math.random() * 10}s`;
                particle.style.animationDuration = `${Math.random() * 5 + 8}s`;
                container.appendChild(particle);
            }
        }

        // ============================================
        // PARTIE 3: CONTRÃ”LE AGENT 137
        // ============================================
        const agent = document.getElementById('agent');
        const agentContainer = document.getElementById('agent-container');
        let agentX = 50; // Position en %
        let currentAnimation = 'idle';

        // Suivi des yeux
        document.addEventListener('mousemove', (e) => {
            const pupils = document.querySelectorAll('.pupil');
            const rect = agent.getBoundingClientRect();
            const agentCenterX = rect.left + rect.width / 2;
            const agentCenterY = rect.top + 40;
            
            const angle = Math.atan2(e.clientY - agentCenterY, e.clientX - agentCenterX);
            const distance = Math.min(3, Math.hypot(e.clientX - agentCenterX, e.clientY - agentCenterY) / 50);
            
            const offsetX = Math.cos(angle) * distance;
            const offsetY = Math.sin(angle) * distance;
            
            pupils.forEach(pupil => {
                pupil.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
            });
        });

        // Changer l'animation de l'agent
        function setAgentAnimation(animName, duration = null) {
            agent.className = 'agent ' + animName;
            currentAnimation = animName;
            
            if (duration) {
                setTimeout(() => {
                    if (currentAnimation === animName) {
                        agent.className = 'agent idle';
                        currentAnimation = 'idle';
                    }
                }, duration);
            }
        }

        // DÃ©placer l'agent
        function moveAgentTo(targetPercent, callback) {
            const currentLeft = parseFloat(agentContainer.style.left) || 50;
            agentX = targetPercent;
            
            // Direction
            if (targetPercent > currentLeft) {
                agentContainer.style.transform = 'translateX(-50%) scaleX(1)';
            } else if (targetPercent < currentLeft) {
                agentContainer.style.transform = 'translateX(-50%) scaleX(-1)';
            }
            
            setAgentAnimation('walking');
            agentContainer.style.left = `${targetPercent}%`;
            
            setTimeout(() => {
                setAgentAnimation('idle');
                agentContainer.style.transform = 'translateX(-50%) scaleX(1)';
                if (callback) callback();
            }, 1000);
        }

        // Actions prÃ©dÃ©finies
        function agentJump() {
            setAgentAnimation('jumping', 600);
        }

        function agentDance() {
            setAgentAnimation('dancing', 3000);
        }

        function agentChickenDance() {
            setAgentAnimation('chicken-dance', 4000);
        }

        function agentRobotBroken() {
            setAgentAnimation('robot-broken', 3000);
        }

        function agentDramaticFall() {
            setAgentAnimation('dramatic-fall', 2000);
            setTimeout(() => {
                // Se relÃ¨ve
                agent.className = 'agent idle';
            }, 3000);
        }

        function agentSing() {
            setAgentAnimation('singing', 4000);
            showThought('ðŸŽµ');
        }

        function agentCatMode() {
            setAgentAnimation('cat-mode', 3000);
            showThought('ðŸ±');
        }

        function agentWave() {
            setAgentAnimation('waving', 2000);
        }

        function agentThink() {
            setAgentAnimation('thinking', 3000);
            showThought('ðŸ¤”');
        }

        function agentSpin() {
            setAgentAnimation('spinning', 800);
        }

        function agentConfused() {
            setAgentAnimation('confused', 2000);
            showThought('â“');
        }

        // Bulle de pensÃ©e
        function showThought(emoji) {
            const bubble = document.getElementById('thought-bubble');
            bubble.textContent = emoji;
            bubble.style.opacity = '1';
            bubble.style.transform = 'scale(1)';
            
            setTimeout(() => {
                bubble.style.opacity = '0';
                bubble.style.transform = 'scale(0)';
            }, 2500);
        }

        // Mood selon confusion
        function updateAgentMood(confusionLevel) {
            agent.classList.remove('mood-confident', 'mood-worried', 'mood-confused', 'mood-panicked');
            
            if (confusionLevel < 25) {
                agent.classList.add('mood-confident');
            } else if (confusionLevel < 50) {
                agent.classList.add('mood-worried');
            } else if (confusionLevel < 75) {
                agent.classList.add('mood-confused');
            } else {
                agent.classList.add('mood-panicked');
            }
        }

        // ============================================
        // SYSTÃˆME DE SKINS ET ACTIONS PAR PERSONNAGE
        // ============================================
        
        // Appliquer le skin visuel du personnage
        function applyCharacterSkin(charId) {
            const char = CHARACTERS[charId];
            
            // Supprimer tous les skins prÃ©cÃ©dents
            const allSkins = ['agent137', 'agent42', 'socrates', 'nietzsche', 'descartes', 'diogenes'];
            allSkins.forEach(skin => agent.classList.remove(skin));
            
            // Appliquer le nouveau skin
            agent.classList.add(charId);
            
            // Mettre Ã  jour le badge si existe
            const badge = document.querySelector('.agent-badge');
            if (badge) {
                badge.textContent = char.emoji;
            }
            
            // Mettre Ã  jour la bulle de pensÃ©e selon personnage
            const thoughts = {
                agent137: 'ðŸ¤”',
                agent42: 'âš¡',
                socrates: 'ðŸ›ï¸',
                nietzsche: 'ðŸ’€',
                descartes: 'ðŸ§ ',
                diogenes: 'ðŸº'
            };
            document.getElementById('thought-bubble').textContent = thoughts[charId] || 'ðŸ¤”';
            
            console.log(`Skin appliquÃ©: ${charId}`);
        }

        // Actions spÃ©cifiques par personnage
        const CHARACTER_ACTIONS = {
            agent137: {
                greeting: () => { agentWave(); showThought('ðŸ˜Ž'); },
                thinking: () => { 
                    agent.classList.add('adjusting-glasses');
                    showThought('ðŸ•µï¸');
                    setTimeout(() => agent.classList.remove('adjusting-glasses'), 1500);
                },
                happy: () => { agentDance(); showThought('ðŸ’ª'); },
                confused: () => { agentConfused(); showThought('ðŸ¤¯'); },
                angry: () => { setAgentAnimation('dramatic-fall', 2000); showThought('ðŸ˜¤'); },
                victory: () => { agentDance(); showThought('ðŸ†'); }
            },
            agent42: {
                greeting: () => { 
                    agent.classList.add('scanning');
                    showThought('ðŸ“¡');
                    setTimeout(() => agent.classList.remove('scanning'), 2000);
                },
                thinking: () => {
                    agent.classList.add('scanning');
                    showThought('ðŸ”');
                    setTimeout(() => agent.classList.remove('scanning'), 2000);
                },
                happy: () => { 
                    agent.classList.add('scanning');
                    playSound('levelUp');
                    showThought('âœ…');
                    setTimeout(() => agent.classList.remove('scanning'), 1500);
                },
                confused: () => {
                    agent.classList.add('glitching');
                    showThought('âš ï¸');
                    setTimeout(() => agent.classList.remove('glitching'), 2000);
                },
                angry: () => {
                    agent.classList.add('glitching');
                    showThought('ðŸ”´');
                    setTimeout(() => agent.classList.remove('glitching'), 2000);
                },
                victory: () => { 
                    agent.classList.add('scanning');
                    showThought('ðŸ¤–');
                    setTimeout(() => agent.classList.remove('scanning'), 3000);
                }
            },
            socrates: {
                greeting: () => {
                    agent.classList.add('questioning');
                    showThought('ðŸ¤');
                    setTimeout(() => agent.classList.remove('questioning'), 2000);
                },
                thinking: () => {
                    agent.classList.add('pondering');
                    showThought('ðŸ¤”');
                    setTimeout(() => agent.classList.remove('pondering'), 3000);
                },
                happy: () => { 
                    agent.classList.add('happy');
                    showThought('ðŸ›ï¸');
                    setTimeout(() => agent.classList.remove('happy'), 2000);
                },
                confused: () => {
                    agent.classList.add('questioning');
                    showThought('â“');
                    setTimeout(() => agent.classList.remove('questioning'), 2000);
                },
                angry: () => {
                    agent.classList.add('angry');
                    showThought('âš–ï¸');
                    setTimeout(() => agent.classList.remove('angry'), 2000);
                },
                victory: () => {
                    agent.classList.add('questioning');
                    showThought('ðŸŽ“');
                    setTimeout(() => agent.classList.remove('questioning'), 3000);
                }
            },
            nietzsche: {
                greeting: () => {
                    agent.classList.add('dramatic');
                    showThought('âš¡');
                    setTimeout(() => agent.classList.remove('dramatic'), 2000);
                },
                thinking: () => {
                    agent.classList.add('intense');
                    showThought('ðŸŒ‘');
                    setTimeout(() => agent.classList.remove('intense'), 2500);
                },
                happy: () => {
                    agent.classList.add('dramatic');
                    showThought('ðŸ¦…');
                    setTimeout(() => agent.classList.remove('dramatic'), 2000);
                },
                confused: () => {
                    agent.classList.add('confused');
                    showThought('ðŸŒ€');
                    setTimeout(() => agent.classList.remove('confused'), 2000);
                },
                angry: () => {
                    agent.classList.add('intense');
                    showThought('ðŸ’€');
                    setTimeout(() => agent.classList.remove('intense'), 2500);
                },
                victory: () => {
                    agent.classList.add('dramatic');
                    showThought('âš¡');
                    playSound('victory');
                    setTimeout(() => agent.classList.remove('dramatic'), 3000);
                }
            },
            descartes: {
                greeting: () => {
                    agentWave();
                    showThought('ðŸŽ©');
                },
                thinking: () => {
                    agent.classList.add('cogito');
                    showThought('ðŸ’­');
                    setTimeout(() => agent.classList.remove('cogito'), 3000);
                },
                happy: () => {
                    agent.classList.add('eureka');
                    showThought('ðŸ’¡');
                    setTimeout(() => agent.classList.remove('eureka'), 1500);
                },
                confused: () => {
                    agent.classList.add('cogito');
                    showThought('â“');
                    setTimeout(() => agent.classList.remove('cogito'), 2500);
                },
                angry: () => {
                    agent.classList.add('angry');
                    showThought('ðŸ“');
                    setTimeout(() => agent.classList.remove('angry'), 2000);
                },
                victory: () => {
                    agent.classList.add('eureka');
                    showThought('ðŸ§ ');
                    setTimeout(() => agent.classList.remove('eureka'), 2000);
                }
            },
            diogenes: {
                greeting: () => {
                    agent.classList.add('laughing');
                    showThought('ðŸ›¢ï¸');
                    setTimeout(() => agent.classList.remove('laughing'), 2000);
                },
                thinking: () => {
                    agent.classList.add('searching');
                    showThought('ðŸ”¦');
                    setTimeout(() => agent.classList.remove('searching'), 3000);
                },
                happy: () => {
                    agent.classList.add('laughing');
                    showThought('ðŸ˜‚');
                    setTimeout(() => agent.classList.remove('laughing'), 2500);
                },
                confused: () => {
                    agent.classList.add('searching');
                    showThought('ðŸ¤·');
                    setTimeout(() => agent.classList.remove('searching'), 2000);
                },
                angry: () => {
                    agent.classList.add('angry');
                    showThought('ðŸ•');
                    setTimeout(() => agent.classList.remove('angry'), 2000);
                },
                victory: () => {
                    agent.classList.add('laughing');
                    showThought('ðŸº');
                    setTimeout(() => agent.classList.remove('laughing'), 3000);
                }
            }
        };

        // ExÃ©cuter une action selon le personnage actuel
        function performCharacterAction(actionType) {
            const charId = gameState.selectedCharacter;
            const actions = CHARACTER_ACTIONS[charId];
            
            if (actions && actions[actionType]) {
                actions[actionType]();
            } else {
                // Fallback vers actions par dÃ©faut
                switch(actionType) {
                    case 'greeting': agentWave(); break;
                    case 'thinking': agentThink(); break;
                    case 'happy': agentDance(); break;
                    case 'confused': agentConfused(); break;
                    case 'angry': agentDramaticFall(); break;
                    case 'victory': agentDance(); break;
                }
            }
        }

        // Analyser la rÃ©ponse et dÃ©clencher des rÃ©actions
        function analyzeResponseAndReact(response, confusionGain) {
            const charId = gameState.selectedCharacter;
            const lowerResponse = response.toLowerCase();
            
            // DÃ©tection des Ã©motions dans la rÃ©ponse
            const emotionPatterns = {
                happy: /ha(ha)+|ðŸ˜‚|ðŸ˜„|excellent|parfait|bravo|bien jouÃ©/i,
                confused: /\?{2,}|confus|perdu|comprends pas|paradox|bizarre/i,
                angry: /!{2,}|ðŸ˜¤|ðŸ˜¡|stop|assez|suffit|ridicule/i,
                thinking: /hmm|intÃ©ressant|voyons|rÃ©flÃ©chi|pense|mÃ©dite/i,
                surprised: /oh|wow|incroyable|impressionn|ðŸ˜®|ðŸ˜²/i
            };

            // RÃ©action basÃ©e sur le gain de confusion
            if (confusionGain >= 15) {
                performCharacterAction('confused');
                triggerCharacterInterruption('high_confusion');
            } else if (confusionGain >= 8) {
                performCharacterAction('thinking');
            } else if (confusionGain <= 2 && gameState.confusion > 30) {
                performCharacterAction('happy');
            }

            // RÃ©action basÃ©e sur le contenu de la rÃ©ponse
            for (const [emotion, pattern] of Object.entries(emotionPatterns)) {
                if (pattern.test(lowerResponse)) {
                    setTimeout(() => {
                        if (emotion === 'happy') performCharacterAction('happy');
                        else if (emotion === 'confused') performCharacterAction('confused');
                        else if (emotion === 'angry') performCharacterAction('angry');
                        else if (emotion === 'thinking') performCharacterAction('thinking');
                        else if (emotion === 'surprised') agentJump();
                    }, 500);
                    break;
                }
            }

            // Interactions spÃ©ciales par personnage
            triggerSpecialInteraction(charId, lowerResponse, confusionGain);
        }

        // Interactions spÃ©ciales uniques par personnage
        function triggerSpecialInteraction(charId, response, confusionGain) {
            switch(charId) {
                case 'agent42':
                    // Robot fait un scan quand il analyse
                    if (response.includes('analyse') || response.includes('calcul') || response.includes('donnÃ©es')) {
                        agent.classList.add('scanning');
                        setTimeout(() => agent.classList.remove('scanning'), 2000);
                    }
                    // Glitch quand trÃ¨s confus
                    if (gameState.confusion > 70) {
                        agent.classList.add('glitching');
                        setTimeout(() => agent.classList.remove('glitching'), 1500);
                    }
                    break;
                    
                case 'socrates':
                    // Caresse la barbe quand il pose une question
                    if (response.includes('?') && response.length > 50) {
                        agent.classList.add('pondering');
                        setTimeout(() => agent.classList.remove('pondering'), 2500);
                    }
                    // Questions rhÃ©toriques
                    if (response.includes('qu\'est-ce que') || response.includes('pourquoi')) {
                        agent.classList.add('questioning');
                        setTimeout(() => agent.classList.remove('questioning'), 2000);
                    }
                    break;
                    
                case 'nietzsche':
                    // Regard intense sur les sujets profonds
                    if (response.includes('existence') || response.includes('mort') || response.includes('dieu') || response.includes('volontÃ©')) {
                        agent.classList.add('intense');
                        setTimeout(() => agent.classList.remove('intense'), 3000);
                    }
                    // Pose dramatique quand il cite
                    if (response.includes('"') || response.includes('ainsi parlait')) {
                        agent.classList.add('dramatic');
                        setTimeout(() => agent.classList.remove('dramatic'), 2500);
                    }
                    break;
                    
                case 'descartes':
                    // Moment eureka sur les rÃ©vÃ©lations
                    if (response.includes('donc') || response.includes('conclusion') || response.includes('Ã©vident')) {
                        agent.classList.add('eureka');
                        showThought('ðŸ’¡');
                        setTimeout(() => agent.classList.remove('eureka'), 1500);
                    }
                    // Cogito quand doute
                    if (response.includes('doute') || response.includes('certain') || response.includes('pense')) {
                        agent.classList.add('cogito');
                        showThought('ðŸ§ ');
                        setTimeout(() => agent.classList.remove('cogito'), 2500);
                    }
                    break;
                    
                case 'diogenes':
                    // Rire cynique sur l'ironie
                    if (response.includes('richesse') || response.includes('pouvoir') || response.includes('sociÃ©tÃ©') || response.includes('convention')) {
                        agent.classList.add('laughing');
                        showThought('ðŸ˜‚');
                        setTimeout(() => agent.classList.remove('laughing'), 2000);
                    }
                    // Cherche l'homme honnÃªte
                    if (response.includes('honneur') || response.includes('vertu') || response.includes('vÃ©ritÃ©')) {
                        agent.classList.add('searching');
                        showThought('ðŸ”¦');
                        setTimeout(() => agent.classList.remove('searching'), 3000);
                    }
                    break;
            }
        }

        // Interruptions de personnage (commentaires spontanÃ©s)
        function triggerCharacterInterruption(trigger) {
            const charId = gameState.selectedCharacter;
            const char = CHARACTERS[charId];
            
            const interruptions = {
                agent137: {
                    high_confusion: ["*ajuste ses lunettes nerveusement* C'est... inhabituel.", "Mon cerveau fait des calculs bizarres lÃ ..."],
                    random: ["*vÃ©rifie sa montre* Le temps passe Ã©trangement...", "*regard suspicieux* Tu caches quelque chose, non?"]
                },
                agent42: {
                    high_confusion: ["âš ï¸ ALERTE: Surcharge cognitive dÃ©tectÃ©e", "Erreur 404: Logique non trouvÃ©e"],
                    random: ["*bip bip* Scan en cours...", "Mise Ã  jour des paramÃ¨tres..."]
                },
                socrates: {
                    high_confusion: ["VoilÃ  une question que mÃªme l'Oracle ne saurait rÃ©soudre...", "Tu me rappelles mes meilleurs Ã©lÃ¨ves... les plus dÃ©rangeants."],
                    random: ["*caresse sa barbe* IntÃ©ressant...", "La seule chose que je sais, c'est que... hmm, j'ai oubliÃ©."]
                },
                nietzsche: {
                    high_confusion: ["L'abÃ®me regarde aussi en toi, il semblerait...", "Tu danses au bord du chaos. J'approuve."],
                    random: ["*regard intense* Ce qui ne me confond pas me rend plus fort.", "Les Ã©toiles sont nÃ©es du chaos. Comme cette conversation."]
                },
                descartes: {
                    high_confusion: ["Je pense, donc je suis... confus.", "Mes coordonnÃ©es cartÃ©siennes sont complÃ¨tement perdues."],
                    random: ["*ajuste sa perruque* Logiquement parlant...", "Le doute est le commencement de la sagesse."]
                },
                diogenes: {
                    high_confusion: ["*Ã©clate de rire* Tu as rÃ©ussi Ã  confondre un homme qui vit dans un tonneau!", "Alexandre aurait pu apprendre de toi!"],
                    random: ["*agite sa lanterne* Toujours pas d'homme honnÃªte...", "La nature est le seul luxe dont j'ai besoin."]
                }
            };

            const charInterruptions = interruptions[charId];
            if (charInterruptions && charInterruptions[trigger]) {
                const messages = charInterruptions[trigger];
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                
                setTimeout(() => {
                    addMessage(randomMessage, false);
                    performCharacterAction('thinking');
                }, 800);
            }
        }

        // Mouvement alÃ©atoire idle
        function randomIdleMovement() {
            if (!gameState.isPlaying || currentAnimation !== 'idle') return;
            
            const actions = [
                () => agentThink(),
                () => moveAgentTo(Math.random() * 40 + 30),
                () => agentWave(),
                () => { /* reste idle */ }
            ];
            
            const randomAction = actions[Math.floor(Math.random() * actions.length)];
            randomAction();
        }

        // DÃ©marrer mouvements idle alÃ©atoires
        setInterval(() => {
            if (Math.random() > 0.7) {
                randomIdleMovement();
            }
        }, 5000);

        // ContrÃ´les clavier
        document.addEventListener('keydown', (e) => {
            // GÃ©rer la touche Escape pour le menu pause
            if (e.key === 'Escape') {
                const gameScreen = document.getElementById('game-screen');
                const pauseScreen = document.getElementById('pause-screen');
                
                // Si on est en jeu, ouvrir le menu pause
                if (gameScreen && gameScreen.classList.contains('active') && gameState.isPlaying) {
                    pauseGame();
                    return;
                }
                
                // Si on est dans le menu pause, reprendre le jeu
                if (pauseScreen && pauseScreen.classList.contains('active')) {
                    resumeGame();
                    return;
                }
            }
            
            if (!gameState.isPlaying) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    moveAgentTo(Math.max(10, agentX - 10));
                    break;
                case 'ArrowRight':
                    moveAgentTo(Math.min(90, agentX + 10));
                    break;
                case ' ':
                    agentJump();
                    break;
                case 'd':
                case 'D':
                    agentDance();
                    break;
                case 'p':
                case 'P':
                    pauseGame();
                    break;
            }
        });

        // ============================================
        // INIT
        // ============================================
        function init() {
            generateBackground();
            renderLevelSelect();
            agentContainer.style.left = '50%';
            
            // Charger le personnage sÃ©lectionnÃ©
            const savedChar = localStorage.getItem('selectedCharacter') || 'agent137';
            selectCharacter(savedChar);
            
            // Afficher le score total sur l'Ã©cran titre
            document.getElementById('total-score-title').textContent = gameState.totalScore;
            
            // Init mÃ©tÃ©o (sera activÃ©e en jeu)
            console.log('ðŸŽ® Agent 137: Mission Confusion - Loaded!');
            console.log(`ðŸ“Š Total Score: ${gameState.totalScore}`);
            console.log(`ðŸ† High Scores: ${gameState.highScores.length}`);
        }
        
        init();
    </script>
</body>
</html>
